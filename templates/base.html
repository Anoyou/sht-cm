<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <script>
        // æè‡´æ€§èƒ½ï¼šåœ¨ä»»ä½• CSS è§£æå‰åº”ç”¨æš—è‰²ä¸»é¢˜ï¼Œå½»åº•æœç»ç™½å±/é»‘å±é—ªçƒ
        (function () {
            try {
                // æ­¤æ—¶ DOM å¯èƒ½æœªå®Œå…¨å°±ç»ªï¼Œä½† documentElement æ€»æ˜¯å­˜åœ¨çš„
                const html = document.documentElement;
                html.classList.add('sidebar-no-transition');

                const theme = localStorage.getItem('theme') || 'auto';

                // æ¸…é™¤æ—§çš„çŠ¶æ€
                html.classList.remove('dark', 'light');

                if (theme === 'dark') {
                    html.classList.add('dark');
                    html.style.backgroundColor = '#000000';
                } else if (theme === 'light') {
                    html.classList.add('light');
                    html.style.backgroundColor = '#f2f2f7';
                } else {
                    // è‡ªåŠ¨æ¨¡å¼ï¼šæ ¹æ®ç³»ç»Ÿåå¥½é¢„è®¾èƒŒæ™¯è‰²
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        html.style.backgroundColor = '#000000';
                    } else {
                        html.style.backgroundColor = '#f2f2f7';
                    }
                    // ä¸æ·»åŠ  dark/light ç±»ï¼Œè®© CSS media query æ¥ç®¡
                }

                const sidebarPref = localStorage.getItem('sidebar_collapsed');
                if (sidebarPref === '1') {
                    html.classList.add('sidebar-pref-collapsed');
                }
            } catch (e) { }
        })();

        // åˆå§‹åŒ–å¹¶åŒæ­¥ç³»ç»Ÿé…ç½®ï¼ˆä»æœåŠ¡å™¨åŠ è½½ï¼‰
        async function syncConfiguration() {
            try {
                // ä»æœåŠ¡å™¨è·å–é…ç½®å€¼
                const response = await fetch('/api/config/values');
                if (!response.ok) return;
                const config = await response.json();

                // 1. åŒæ­¥å®‰å…¨æ¨¡å¼
                const safeMode = !!config.SAFE_MODE;
                if (safeMode) {
                    document.body.classList.add('safe-mode');
                } else {
                    document.body.classList.remove('safe-mode');
                }

                // åŒæ­¥é…ç½®é¡µé¢çš„å¼€å…³çŠ¶æ€ (å¦‚æœå½“å‰åœ¨é…ç½®é¡µ)
                const safeModeSwitch = document.getElementById('cfg-safe-mode');
                const safeModeLabel = document.getElementById('safe-mode-label');
                if (safeModeSwitch && safeModeSwitch.checked !== safeMode && document.activeElement !== safeModeSwitch) {
                    safeModeSwitch.checked = safeMode;
                    if (safeModeLabel) safeModeLabel.textContent = safeMode ? 'å¼€å¯' : 'å…³é—­';
                }

                // 2. è°ƒåº¦çˆ¬è™«é¡µé¢åŒæ­¥ (å¦‚æœå½“å‰åœ¨çˆ¬è™«é¡µä¸”æœ‰ç›¸åº”å‡½æ•°)
                if (typeof window.syncCrawlerUI === 'function') {
                    window.syncCrawlerUI(config);
                    // ğŸš€ å¦‚æœåœ¨çˆ¬è™«é¡µï¼ŒåŒæ­¥é…ç½®æ—¶é¡ºä¾¿å³åˆ»åˆ·æ–°ä¸€æ¬¡çˆ¬è™«çŠ¶æ€
                    if (typeof window.checkCrawlStatus === 'function') {
                        window.checkCrawlStatus();
                    }
                }

                // console.log('ç³»ç»Ÿé…ç½®åŒæ­¥å®Œæˆ');
            } catch (e) {
                // é™é»˜å¤±è´¥ï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
            }
        }

        // é¡µé¢åˆæ¬¡åŠ è½½
        document.addEventListener('DOMContentLoaded', syncConfiguration);

        // æ ¸å¿ƒåŒæ­¥é€»è¾‘ï¼š
        // 1. ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ– (ä»å…¶ä»–æ ‡ç­¾é¡µåˆ‡å›æ—¶å³åˆ»åŒæ­¥)
        document.addEventListener('visibilitychange', function () {
            if (!document.hidden) {
                syncConfiguration();
            }
        });

        // 2. å®šæ—¶è½®è¯¢ (å³ä½¿é¡µé¢åœ¨åå°æˆ–è·¨è®¾å¤‡æ“ä½œä¹Ÿèƒ½æ„Ÿåº”)
        // è®¾ä¸º 30 ç§’è½®è¯¢ä¸€æ¬¡ï¼Œå¹³è¡¡æ€§èƒ½ä¸ä½“éªŒ
        setInterval(syncConfiguration, 30000);

        // 3. ç§»åŠ¨ç«¯ä¾§è¾¹æ å±•å¼€æ—¶ï¼Œè°ƒæ•´æµ®åŠ¨æ¡z-index
        function adjustFloatingBarZIndex() {
            const sidebar = document.querySelector('.sidebar');
            const floatingBar = document.querySelector('.floating-save-bar');
            const pagination = document.querySelector('.pagination');

            if (!sidebar) return;

            const isExpanded = sidebar.getAttribute('data-state') === 'expanded';
            const zIndex = isExpanded ? '30' : '40';

            if (floatingBar) floatingBar.style.zIndex = zIndex;
            if (pagination) pagination.style.zIndex = zIndex;
        }

        // ç›‘å¬ä¾§è¾¹æ çŠ¶æ€å˜åŒ–
        const observer = new MutationObserver(adjustFloatingBarZIndex);
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                observer.observe(sidebar, { attributes: true, attributeFilter: ['data-state'] });
                adjustFloatingBarZIndex();
            }
        });
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <!-- iOS/PWA ä¸»é¢˜è‰²é€‚é… - è®¾ç½®ä¸º Header çš„åŸºå‡†è‰²ä»¥å®ç°æ— ç¼èåˆ -->
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1e1e1e" media="(prefers-color-scheme: dark)">

    <!-- iPhone ä¸“ç”¨ä¼˜åŒ– -->
    <meta name="format-detection" content="telephone=no, date=no, email=no, address=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" id="status-bar-style">
    <meta name="apple-mobile-web-app-title" content="SHTèµ„æºç®¡ç†">
    <meta name="apple-touch-fullscreen" content="yes">

    <!-- iOS å®‰å…¨åŒºåŸŸå’Œç¼©æ”¾æ§åˆ¶ -->
    <meta name="color-scheme" content="light dark">
    <meta name="supported-color-schemes" content="light dark">

    <!-- PWA æ”¯æŒ -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512x512.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">

    <!-- iOS PWA å¯åŠ¨ç”»é¢ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icons/apple-splash-2048-2732.png') }}"
        media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icons/apple-splash-1668-2224.png') }}"
        media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icons/apple-splash-1536-2048.png') }}"
        media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icons/apple-splash-1125-2436.png') }}"
        media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icons/apple-splash-1242-2208.png') }}"
        media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icons/apple-splash-750-1334.png') }}"
        media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icons/apple-splash-640-1136.png') }}"
        media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">

    <title>{% block title %}SHTèµ„æºèšåˆç³»ç»Ÿ{% endblock %}</title>

    <!-- ç»Ÿä¸€çš„CSSæ ·å¼ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    <!-- é¡µé¢ç‰¹å®šçš„CSS -->
    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- çŠ¶æ€æ è¦†ç›–å±‚ - å¿…é¡»æ˜¯ body çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ ï¼Œç”¨äº iOS ä¸»é¢˜åˆ‡æ¢æ—¶å®æ—¶æ›´æ–°çŠ¶æ€æ é¢œè‰² -->
    <div class="status-bar-overlay" id="statusBarOverlay"></div>
    <div class="safe-area-bottom-overlay" id="safeAreaBottomOverlay"></div>

    <div class="group/sidebar-wrapper">
        <!-- Toastå®¹å™¨ -->
        <div id="toastContainer" class="toast-container"></div>

        <!-- ä¾§è¾¹æ  -->
        {% include 'components/sidebar.html' %}

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div id="content">
            <!-- é¡¶éƒ¨æ  -->
            {% include 'components/header.html' %}

            <!-- ä¸»è¦å†…å®¹ -->
            <main class="main-content">
                {% block content %}{% endblock %}
            </main>
        </div>

        <!-- å¥åº·æ£€æŸ¥æŠ½å±‰ -->
        {% include 'components/health_drawer.html' %}

        <!-- æ›´æ–°æ—¥å¿—æŠ½å±‰ -->
        {% include 'components/changelog_drawer.html' %}
    </div>

    <!-- ç»Ÿä¸€çš„JavaScript -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <!-- PWA Service Worker æ³¨å†Œ -->
    <script>
        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);

                        // æ£€æŸ¥æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨
                                    showConfirmToast('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ',
                                        () => {
                                            newWorker.postMessage({ type: 'SKIP_WAITING' });
                                            window.location.reload();
                                        },
                                        () => {
                                            console.log('ç”¨æˆ·å–æ¶ˆæ›´æ–°');
                                        }
                                    );
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('SW registration failed: ', error);
                    });

                // ç›‘å¬ Service Worker æ§åˆ¶å™¨å˜åŒ–
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });
            });
        }

        // PWA å®‰è£…æç¤º
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // æ˜¾ç¤ºå®‰è£…æç¤ºï¼ˆå¯ä»¥è‡ªå®šä¹‰UIï¼‰
            console.log('PWA å¯ä»¥å®‰è£…');

            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºè‡ªå®šä¹‰çš„å®‰è£…æŒ‰é’®
            // showInstallButton();
        });

        // å®‰è£…å®Œæˆåçš„å¤„ç†
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA å·²å®‰è£…');
            deferredPrompt = null;
        });
    </script>

    <!-- é¡µé¢ç‰¹å®šçš„JavaScript -->
    {% block extra_js %}{% endblock %}
</body>

</html>