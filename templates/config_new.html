{% extends "base.html" %}

{% block title %}系统配置 - SHT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/config.css') }}">
{% endblock %}

{% block content %}
<h1 class="page-title">系统配置</h1>

<div class="config-grid">
    <!-- 系统配置卡片 -->
    <div class="config-card">
        <h3>系统配置</h3>
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">代理设置</div>
                <div class="form-desc">HTTP/HTTPS代理服务器地址</div>
            </div>
            <div class="form-right">
                <input type="text" id="cfg-proxy" placeholder="http://proxy:port">
                <span id="badge-proxy" class="status-badge">未配置</span>
            </div>
        </div>
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">绕过地址</div>
                <div class="form-desc">绕过CloudFlare的备用地址</div>
            </div>
            <div class="form-right">
                <input type="text" id="cfg-bypass" placeholder="https://bypass.example.com">
                <span id="badge-bypass" class="status-badge">未配置</span>
            </div>
        </div>
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">Telegram Bot Token</div>
                <div class="form-desc">机器人令牌（用于通知）</div>
            </div>
            <div class="form-right">
                <input type="password" id="cfg-token" placeholder="输入Bot Token">
                <span id="badge-token" class="status-badge">未配置</span>
            </div>
        </div>
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">Telegram Chat ID</div>
                <div class="form-desc">通知目标 ID（个人或群组）</div>
            </div>
            <div class="form-right">
                <input type="text" id="cfg-chat-id" placeholder="输入Chat ID">
                <span id="badge-chat-id" class="status-badge">未配置</span>
            </div>
        </div>
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">FlareSolverr 地址</div>
                <div class="form-desc">解决 CloudFlare 验证的服务地址</div>
            </div>
            <div class="form-right">
                <input type="text" id="cfg-flaresolverr" placeholder="http://localhost:8191">
                <span id="badge-flaresolverr" class="status-badge">未配置</span>
            </div>
        </div>
    </div>

    <!-- Telegram 模板配置卡片 -->
    <div class="config-card">
        <div class="card-header-flex">
            <h3>Telegram 通知模板</h3>
            <div class="header-actions">
                <button class="btn-text-immersive" onclick="togglePlaceholderDrawer()">※ 点击此处查看占位符使用说明</button>
                <span id="badge-telegram-templates" class="status-badge">未加载</span>
            </div>
        </div>

        <div id="template-drawer" class="template-drawer">
            <div class="template-drawer-header">占位符说明</div>
            <pre id="tpl-placeholders" class="template-drawer-content">加载中...</pre>
        </div>

        <div class="template-form">
            <!-- 解析模式选择器已移除 -->

            <details class="template-section">
                <summary>爬取结束报告（crawl_report）</summary>
                <div class="template-grid">
                    <div class="template-item">
                        <div class="template-item-label">标题</div>
                        <textarea id="cfg-tpl-cr-title" class="template-input" rows="2"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">分隔线</div>
                        <input id="cfg-tpl-cr-separator" class="template-input" type="text">
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">完成状态行</div>
                        <textarea id="cfg-tpl-cr-status-line" class="template-input" rows="2"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">异常原因行</div>
                        <textarea id="cfg-tpl-cr-exception-line" class="template-input" rows="2"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">耗时行</div>
                        <textarea id="cfg-tpl-cr-duration-line" class="template-input" rows="2"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">配置描述行</div>
                        <textarea id="cfg-tpl-cr-config-line" class="template-input" rows="2"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">统计汇总行</div>
                        <textarea id="cfg-tpl-cr-summary-line" class="template-input" rows="2"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">板块标题</div>
                        <input id="cfg-tpl-cr-section-header" class="template-input" type="text">
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">板块明细行</div>
                        <textarea id="cfg-tpl-cr-section-line" class="template-input" rows="2"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">无变动提示</div>
                        <input id="cfg-tpl-cr-empty-section" class="template-input" type="text">
                    </div>
                </div>
            </details>

            <details class="template-section">
                <summary>过程通知（messages）</summary>
                <div class="template-grid">
                    <div class="template-item">
                        <div class="template-item-label">开始爬取</div>
                        <textarea id="cfg-tpl-msg-initial-report" class="template-input" rows="4"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">板块切换</div>
                        <textarea id="cfg-tpl-msg-board-switch" class="template-input" rows="4"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">心跳通知</div>
                        <textarea id="cfg-tpl-msg-heartbeat" class="template-input" rows="4"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">线程异常</div>
                        <textarea id="cfg-tpl-msg-crawler-thread-exception" class="template-input" rows="4"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">详情页异常</div>
                        <textarea id="cfg-tpl-msg-detail-page-exception" class="template-input" rows="4"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">板块错误警报</div>
                        <textarea id="cfg-tpl-msg-section-error-alert" class="template-input" rows="3"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">错误超限停止</div>
                        <textarea id="cfg-tpl-msg-error-limit-stop" class="template-input" rows="4"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">任务停止</div>
                        <textarea id="cfg-tpl-msg-task-stopped" class="template-input" rows="4"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">线程错误</div>
                        <textarea id="cfg-tpl-msg-crawler-thread-error" class="template-input" rows="3"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">错误过多停止</div>
                        <textarea id="cfg-tpl-msg-crawler-error-stop" class="template-input" rows="3"></textarea>
                    </div>
                    <div class="template-item">
                        <div class="template-item-label">状态变更</div>
                        <textarea id="cfg-tpl-msg-state-change" class="template-input" rows="3"></textarea>
                    </div>
                </div>
            </details>



            <div class="template-footer-actions">
                <button class="btn btn-primary" onclick="loadTelegramTemplates()">加载模板</button>
                <button class="btn btn-purple" onclick="saveTelegramTemplates()">保存模板</button>
                <button class="btn btn-warning" onclick="resetTelegramTemplates()">恢复默认</button>
            </div>
        </div>
    </div>

    <!-- 日志配置卡片 -->
    <div class="config-card">
        <h3>日志配置</h3>
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">日志级别</div>
                <div class="form-desc">控制日志详细程度</div>
            </div>
            <div class="form-right">
                <select id="cfg-log-level">
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>
                <span id="badge-log-level" class="status-badge ok">已配置</span>
            </div>
        </div>
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">日志缓冲区大小</div>
                <div class="form-desc">Web界面显示的日志条数（1000-100000条）</div>
            </div>
            <div class="form-right">
                <input type="number" id="cfg-log-buffer-size" min="1000" max="100000" step="1000" placeholder="10000">
                <span id="badge-log-buffer-size" class="status-badge ok">已配置</span>
            </div>
        </div>
    </div>

    <!-- 爬虫配置卡片 -->
    <div class="config-card">
        <h3>爬虫配置</h3>
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">爬虫模式</div>
                <div class="form-desc">async=异步高性能 / thread=多线程 / sync=单线程串行</div>
            </div>
            <div class="form-right">
                <select id="cfg-crawler-mode" onchange="toggleCrawlerFields()">
                    <option value="async">异步高性能模式 (async) - 推荐</option>
                    <option value="thread">同步多线程模式 (thread)</option>
                    <option value="sync">单线程串行模式 (sync)</option>
                </select>
                <span id="badge-crawler-mode" class="status-badge ok">已配置</span>
            </div>
        </div>

        <!-- 异步模式专属设置 -->
        <div id="async-settings" class="crawler-specific-settings">
            <div class="form-field">
                <div class="form-left">
                    <div class="form-label">异步并发数</div>
                    <div class="form-desc">同时发起的 HTTP 请求数量 (建议: 10-30)</div>
                </div>
                <div class="form-right">
                    <input type="number" id="cfg-crawler-concurrency" min="1" max="50" step="1" placeholder="20">
                    <span id="badge-crawler-concurrency" class="status-badge ok">已配置</span>
                </div>
            </div>

            <div class="form-field">
                <div class="form-left">
                    <div class="form-label">详情页爬取随机延迟 (秒)</div>
                    <div class="form-desc">异步模式下每个详情页请求前的错峰延迟 (建议: 0.3 - 1.5)</div>
                </div>
                <div class="form-right" style="gap: 0.5rem;">
                    <input type="number" id="cfg-async-delay-min" min="0" max="10" step="0.1" placeholder="0.3"
                        style="width: 45%;">
                    <span>-</span>
                    <input type="number" id="cfg-async-delay-max" min="0" max="10" step="0.1" placeholder="1.5"
                        style="width: 45%;">
                    <span id="badge-async-delay" class="status-badge ok">已配置</span>
                </div>
            </div>
        </div>

        <!-- 多线程模式专属设置 -->
        <div id="thread-settings" class="crawler-specific-settings" style="display: none;">
            <div class="form-field">
                <div class="form-left">
                    <div class="form-label">多线程数量</div>
                    <div class="form-desc">并行工作的处理线程数量 (建议: 5-15)</div>
                </div>
                <div class="form-right">
                    <input type="number" id="cfg-crawler-thread-count" min="1" max="50" step="1" placeholder="10">
                    <span id="badge-crawler-thread-count" class="status-badge ok">已配置</span>
                </div>
            </div>
        </div>

        <!-- 同步/多线程模式共享延迟设置 -->
        <div id="sync-settings" class="crawler-specific-settings" style="display: none;">
            <div class="form-field">
                <div class="form-left">
                    <div class="form-label">页面请求随机延迟 (秒)</div>
                    <div class="form-desc">多线程/同步模式下每个页面请求间的错峰延迟 (建议: 0.3 - 1.5)</div>
                </div>
                <div class="form-right" style="gap: 0.5rem;">
                    <input type="number" id="cfg-sync-delay-min" min="0" max="10" step="0.1" placeholder="0.3"
                        style="width: 45%;">
                    <span>-</span>
                    <input type="number" id="cfg-sync-delay-max" min="0" max="10" step="0.1" placeholder="1.5"
                        style="width: 45%;">
                    <span id="badge-sync-delay" class="status-badge ok">已配置</span>
                </div>
            </div>
        </div>

        <!-- 心跳通知设置 -->
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">心跳通知间隔</div>
                <div class="form-desc">爬虫任务运行期间的进度通知频率 (建议: 30-300秒)</div>
            </div>
            <div class="form-right">
                <input type="number" id="cfg-heartbeat-interval" min="10" max="600" step="10" placeholder="60">
                <span>秒</span>
                <span id="badge-heartbeat-interval" class="status-badge ok">已配置</span>
            </div>
        </div>

        <!-- 全局错误阈值设置 -->
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">全局错误阈值</div>
                <div class="form-desc">任务失败次数超过此值时自动停止 (建议: 100-1000)</div>
            </div>
            <div class="form-right">
                <input type="number" id="cfg-global-error-threshold" min="10" max="5000" step="10" placeholder="300">
                <span id="badge-global-error-threshold" class="status-badge ok">已配置</span>
            </div>
        </div>
    </div>

    <!-- 功能开关卡片 -->
    <div class="config-card">
        <h3>功能开关</h3>
        <div class="form-field">
            <div class="form-left">
                <div class="form-label">每日定时爬取</div>
                <div class="form-desc">每天自动执行一次增量爬取（固定抓取48小时内前3页，全板块）</div>
            </div>
            <div class="form-right">
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="cfg-auto-crawl">
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label" id="auto-crawl-label">关闭</span>
                </div>
            </div>
        </div>

        <div class="form-field" id="auto-crawl-time-field" style="display: none;">
            <div class="form-left">
                <div class="form-label">定时爬取时间</div>
                <div class="form-desc">每日执行的具体时间点</div>
            </div>
            <div class="form-right">
                <input type="time" id="cfg-auto-crawl-time" value="03:00">
                <span id="badge-auto-crawl-time" class="status-badge ok">已配置</span>
            </div>
        </div>

        <div class="form-field">
            <div class="form-left">
                <div class="form-label">安全模式</div>
                <div class="form-desc">开启后资源卡片图片将被模糊遮罩，点击可查看大图</div>
            </div>
            <div class="form-right">
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="cfg-safe-mode">
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label" id="safe-mode-label">关闭</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 浮动保存按钮 -->
<div class="floating-save-bar">
    <button id="save-config-btn" onclick="saveConfig()" class="btn btn-purple">保存配置</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    /**
     * 根据选择的爬虫模式显示/隐藏对应设置
     */
    function toggleCrawlerFields() {
        const mode = document.getElementById('cfg-crawler-mode').value;
        document.getElementById('async-settings').style.display = (mode === 'async') ? 'block' : 'none';
        document.getElementById('thread-settings').style.display = (mode === 'thread') ? 'block' : 'none';
        // 多线程和同步模式共享该延迟设置
        document.getElementById('sync-settings').style.display = (mode === 'thread' || mode === 'sync') ? 'block' : 'none';
    }

    async function loadConfigValues() {
        try {
            const response = await fetch('/api/config/values');
            if (!response.ok) throw new Error('Network response was not ok');
            const config = await response.json();

            // 基础配置
            document.getElementById('cfg-proxy').value = config.PROXY || '';
            document.getElementById('cfg-bypass').value = config.BYPASS_URL || '';
            document.getElementById('cfg-token').value = config.TG_BOT_TOKEN || '';
            document.getElementById('cfg-chat-id').value = config.TG_NOTIFY_CHAT_ID || '';
            document.getElementById('cfg-flaresolverr').value = config.FLARE_SOLVERR_URL || '';
            document.getElementById('cfg-log-level').value = config.LOG_LEVEL || 'INFO';
            document.getElementById('cfg-log-buffer-size').value = config.LOG_BUFFER_SIZE || 10000;
            document.getElementById('cfg-crawler-mode').value = config.CRAWLER_MODE || 'async';

            // 爬虫详细配置
            document.getElementById('cfg-crawler-concurrency').value = config.CRAWLER_MAX_CONCURRENCY || 20;
            document.getElementById('cfg-crawler-thread-count').value = config.CRAWLER_THREAD_COUNT || 10;
            document.getElementById('cfg-async-delay-min').value = config.CRAWLER_ASYNC_DELAY_MIN || 0.5;
            document.getElementById('cfg-async-delay-max').value = config.CRAWLER_ASYNC_DELAY_MAX || 1.5;
            document.getElementById('cfg-sync-delay-min').value = config.CRAWLER_SYNC_DELAY_MIN || 0.3;
            document.getElementById('cfg-sync-delay-max').value = config.CRAWLER_SYNC_DELAY_MAX || 0.8;
            document.getElementById('cfg-heartbeat-interval').value = config.HEARTBEAT_INTERVAL || 60;
            document.getElementById('cfg-global-error-threshold').value = config.GLOBAL_ERROR_THRESHOLD || 300;

            // 【修复】更新所有状态badge
            updateAllStatusBadges();

            // 安全模式
            const safeMode = config.SAFE_MODE || false;
            document.getElementById('cfg-safe-mode').checked = safeMode;
            updateSafeModeLabel(safeMode);
            if (safeMode) document.body.classList.add('safe-mode');

            // 触发显隐切换
            toggleCrawlerFields();

            // 定时爬取
            const autoCrawl = config.AUTO_CRAWL_ENABLED || false;
            document.getElementById('cfg-auto-crawl').checked = autoCrawl;
            document.getElementById('cfg-auto-crawl-time').value = config.AUTO_CRAWL_TIME || '03:00';
            updateAutoCrawlUI(autoCrawl);

        } catch (error) {
            console.error('加载配置失败:', error);
            showToast('加载配置失败，请刷新页面重试', 'error');
        }
    }

    const TEMPLATE_FIELDS = {
        parse_mode: 'cfg-tpl-parse-mode',
        crawl_report: {
            title: 'cfg-tpl-cr-title',
            separator: 'cfg-tpl-cr-separator',
            status_line: 'cfg-tpl-cr-status-line',
            exception_line: 'cfg-tpl-cr-exception-line',
            duration_line: 'cfg-tpl-cr-duration-line',
            config_line: 'cfg-tpl-cr-config-line',
            summary_line: 'cfg-tpl-cr-summary-line',
            section_header: 'cfg-tpl-cr-section-header',
            section_line: 'cfg-tpl-cr-section-line',
            empty_section: 'cfg-tpl-cr-empty-section'
        },
        messages: {
            initial_report: 'cfg-tpl-msg-initial-report',
            board_switch: 'cfg-tpl-msg-board-switch',
            heartbeat: 'cfg-tpl-msg-heartbeat',
            crawler_thread_exception: 'cfg-tpl-msg-crawler-thread-exception',
            section_error_alert: 'cfg-tpl-msg-section-error-alert',
            error_limit_stop: 'cfg-tpl-msg-error-limit-stop',
            task_stopped: 'cfg-tpl-msg-task-stopped',
            crawler_thread_error: 'cfg-tpl-msg-crawler-thread-error',
            crawler_error_stop: 'cfg-tpl-msg-crawler-error-stop',
            state_change: 'cfg-tpl-msg-state-change'
        }
    };

    function updateTemplateBadge(text, type = 'default') {
        const badge = document.getElementById('badge-telegram-templates');
        if (!badge) return;
        badge.textContent = text;
        badge.className = 'status-badge';
        if (type === 'ok') badge.className = 'status-badge ok';
        if (type === 'warning') badge.className = 'status-badge warning';
    }

    function stableStringify(obj) {
        if (obj === null || typeof obj !== 'object') return JSON.stringify(obj);
        if (Array.isArray(obj)) return '[' + obj.map(stableStringify).join(',') + ']';
        const keys = Object.keys(obj).sort();
        return '{' + keys.map(k => JSON.stringify(k) + ':' + stableStringify(obj[k])).join(',') + '}';
    }

    function applyTemplateValue(id, value) {
        const el = document.getElementById(id);
        if (el) el.value = value ?? '';
    }

    function fillTemplateForm(templates) {
        if (!templates || typeof templates !== 'object') return;
        applyTemplateValue(TEMPLATE_FIELDS.parse_mode, templates.parse_mode || 'MarkdownV2');

        const crawl = templates.crawl_report || {};
        Object.keys(TEMPLATE_FIELDS.crawl_report).forEach(key => {
            applyTemplateValue(TEMPLATE_FIELDS.crawl_report[key], crawl[key] ?? '');
        });

        const messages = templates.messages || {};
        Object.keys(TEMPLATE_FIELDS.messages).forEach(key => {
            applyTemplateValue(TEMPLATE_FIELDS.messages[key], messages[key] ?? '');
        });
    }

    function collectTemplateForm() {
        const crawl_report = {};
        Object.keys(TEMPLATE_FIELDS.crawl_report).forEach(key => {
            const el = document.getElementById(TEMPLATE_FIELDS.crawl_report[key]);
            crawl_report[key] = el ? el.value : '';
        });

        const messages = {};
        Object.keys(TEMPLATE_FIELDS.messages).forEach(key => {
            const el = document.getElementById(TEMPLATE_FIELDS.messages[key]);
            messages[key] = el ? el.value : '';
        });

        const parseModeEl = document.getElementById(TEMPLATE_FIELDS.parse_mode);
        return {
            parse_mode: parseModeEl ? parseModeEl.value : 'MarkdownV2',
            crawl_report,
            messages
        };
    }

    function setTemplateOriginal(templates) {
        const container = document.getElementById('badge-telegram-templates');
        if (!container) return;
        container.dataset.original = stableStringify(templates || {});
    }

    function updateTemplateDirtyState() {
        const badge = document.getElementById('badge-telegram-templates');
        if (!badge) return;
        const original = badge.dataset.original || '';
        const current = stableStringify(collectTemplateForm());
        if (original && current === original) {
            updateTemplateBadge('已保存', 'ok');
        } else {
            updateTemplateBadge('未保存', 'warning');
        }
    }

    async function loadTelegramTemplates() {
        try {
            updateTemplateBadge('加载中...', 'warning');
            const response = await fetch('/api/config/telegram-templates');
            if (!response.ok) throw new Error('Network response was not ok');
            const payload = await response.json();
            const data = payload?.data || payload || {};
            const templates = data.templates || {};
            const placeholders = data.placeholders || '';

            fillTemplateForm(templates);
            setTemplateOriginal(templates);
            updateTemplateBadge('通知模板已加载', 'ok');

            const placeholderEl = document.getElementById('tpl-placeholders');
            if (placeholderEl) {
                placeholderEl.textContent = placeholders || '暂无占位符说明';
            }
        } catch (error) {
            console.error('加载模板失败:', error);
            updateTemplateBadge('加载失败', 'warning');
            showToast('加载模板失败，请稍后重试', 'error');
        }
    }

    async function saveTelegramTemplates() {
        try {
            const templates = collectTemplateForm();
            updateTemplateBadge('保存中...', 'warning');
            const response = await fetch('/api/config/telegram-templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ templates })
            });
            if (!response.ok) throw new Error('Save failed');
            setTemplateOriginal(templates);
            updateTemplateBadge('已保存', 'ok');
            showToast('模板已保存', 'success');
        } catch (error) {
            console.error('保存模板失败:', error);
            updateTemplateBadge('保存失败', 'warning');
            showToast('保存模板失败: ' + error.message, 'error');
        }
    }

    async function resetTelegramTemplates() {
        const confirmed = confirm('确定恢复默认模板吗？当前内容将被覆盖。');
        if (!confirmed) return;
        try {
            updateTemplateBadge('恢复中...', 'warning');
            const response = await fetch('/api/config/telegram-templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'reset' })
            });
            if (!response.ok) throw new Error('Reset failed');
            await loadTelegramTemplates();
            updateTemplateBadge('已恢复', 'ok');
            showToast('模板已恢复默认', 'success');
        } catch (error) {
            console.error('恢复模板失败:', error);
            updateTemplateBadge('恢复失败', 'warning');
            showToast('恢复模板失败: ' + error.message, 'error');
        }
    }

    function bindTemplateForm() {
        const ids = [
            TEMPLATE_FIELDS.parse_mode,
            ...Object.values(TEMPLATE_FIELDS.crawl_report),
            ...Object.values(TEMPLATE_FIELDS.messages)
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const evt = el.tagName === 'SELECT' ? 'change' : 'input';
            el.addEventListener(evt, updateTemplateDirtyState);
        });
    }

    function togglePlaceholderDrawer() {
        const drawer = document.getElementById('template-drawer');
        if (!drawer) return;
        drawer.classList.toggle('open');
    }

    async function saveConfig() {
        const saveBtn = document.getElementById('save-config-btn');
        if (saveBtn.disabled) return;

        try {
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';

            const configData = {
                PROXY: document.getElementById('cfg-proxy').value.trim(),
                BYPASS_URL: document.getElementById('cfg-bypass').value.trim(),
                TG_BOT_TOKEN: document.getElementById('cfg-token').value.trim(),
                TG_NOTIFY_CHAT_ID: document.getElementById('cfg-chat-id').value.trim(),
                FLARE_SOLVERR_URL: document.getElementById('cfg-flaresolverr').value.trim(),
                LOG_LEVEL: document.getElementById('cfg-log-level').value,
                LOG_BUFFER_SIZE: parseInt(document.getElementById('cfg-log-buffer-size').value) || 10000,
                CRAWLER_MODE: document.getElementById('cfg-crawler-mode').value,

                CRAWLER_MAX_CONCURRENCY: parseInt(document.getElementById('cfg-crawler-concurrency').value) || 20,
                CRAWLER_THREAD_COUNT: parseInt(document.getElementById('cfg-crawler-thread-count').value) || 10,
                CRAWLER_ASYNC_DELAY_MIN: parseFloat(document.getElementById('cfg-async-delay-min').value) || 0.5,
                CRAWLER_ASYNC_DELAY_MAX: parseFloat(document.getElementById('cfg-async-delay-max').value) || 1.5,
                CRAWLER_SYNC_DELAY_MIN: parseFloat(document.getElementById('cfg-sync-delay-min').value) || 0.3,
                CRAWLER_SYNC_DELAY_MAX: parseFloat(document.getElementById('cfg-sync-delay-max').value) || 0.8,
                HEARTBEAT_INTERVAL: parseInt(document.getElementById('cfg-heartbeat-interval').value) || 60,
                GLOBAL_ERROR_THRESHOLD: parseInt(document.getElementById('cfg-global-error-threshold').value) || 300,

                SAFE_MODE: document.getElementById('cfg-safe-mode').checked,
                AUTO_CRAWL_ENABLED: document.getElementById('cfg-auto-crawl').checked,
                AUTO_CRAWL_TIME: document.getElementById('cfg-auto-crawl-time').value || '03:00'
            };

            // 添加请求超时控制（30秒）
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            const response = await fetch('/api/config/set', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(configData),
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            // 解析响应数据
            let result;
            try {
                result = await response.json();
            } catch (e) {
                result = { success: false, message: '无法解析服务器响应' };
            }

            if (response.ok && result.success) {
                showToast(result.message || '配置保存成功', 'success');
                // 【修复】更新所有状态badge
                updateAllStatusBadges();
            } else {
                const errorMsg = result.message || result.details || `HTTP ${response.status}`;
                throw new Error(errorMsg);
            }
        } catch (error) {
            console.error('保存配置失败:', error);
            if (error.name === 'AbortError') {
                showToast('保存超时，请检查网络连接或服务器状态', 'error');
            } else {
                showToast('保存配置失败: ' + error.message, 'error');
            }
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = '保存配置';
        }
    }

    function setTextContent(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
    }

    function updateAllStatusBadges() {
        // 系统配置项
        updateItemBadge('badge-proxy', 'cfg-proxy');
        updateItemBadge('badge-bypass', 'cfg-bypass');
        updateItemBadge('badge-token', 'cfg-token');
        updateItemBadge('badge-chat-id', 'cfg-chat-id');
        updateItemBadge('badge-flaresolverr', 'cfg-flaresolverr');

        // 日志配置项（总是已配置）
        updateItemBadge('badge-log-level', 'cfg-log-level', true);
        updateItemBadge('badge-log-buffer-size', 'cfg-log-buffer-size', true);

        // 爬虫配置项（总是已配置）
        updateItemBadge('badge-crawler-mode', 'cfg-crawler-mode', true);
        updateItemBadge('badge-crawler-concurrency', 'cfg-crawler-concurrency', true);
        updateItemBadge('badge-async-delay', 'cfg-async-delay-min', true);
        updateItemBadge('badge-crawler-thread-count', 'cfg-crawler-thread-count', true);
        updateItemBadge('badge-sync-delay', 'cfg-sync-delay-min', true);
        updateItemBadge('badge-heartbeat-interval', 'cfg-heartbeat-interval', true);
        updateItemBadge('badge-global-error-threshold', 'cfg-global-error-threshold', true);

        // 功能开关项（总是已配置）
        updateItemBadge('badge-auto-crawl-time', 'cfg-auto-crawl-time', true);
    }

    function updateItemBadge(badgeId, inputId, alwaysConfigured = false) {
        const badge = document.getElementById(badgeId);
        const input = document.getElementById(inputId);

        if (!badge || !input) return;

        let isConfigured = alwaysConfigured;

        if (!alwaysConfigured) {
            // 检查输入框是否有值
            const value = input.value ? input.value.trim() : '';
            isConfigured = value.length > 0;
        }

        if (isConfigured) {
            badge.textContent = '已配置';
            badge.className = 'status-badge ok';
        } else {
            badge.textContent = '未配置';
            badge.className = 'status-badge';
        }
    }

    function initSafeModeSwitch() {
        const sw = document.getElementById('cfg-safe-mode');
        if (!sw) return;
        sw.addEventListener('change', async function () {
            const enabled = this.checked;
            updateSafeModeLabel(enabled);
            if (enabled) document.body.classList.add('safe-mode');
            else document.body.classList.remove('safe-mode');

            // 【新增】通知其他标签页安全模式已改变
            try {
                const channel = new BroadcastChannel('safe_mode_channel');
                channel.postMessage({
                    type: 'SAFE_MODE_CHANGED',
                    safeMode: enabled
                });
                channel.close();
            } catch (e) {
                console.warn('BroadcastChannel 不支持，跨标签页同步不可用');
            }

            try {
                await fetch('/api/config/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ SAFE_MODE: enabled })
                });
            } catch (e) { console.error('Safe mode sync failed', e); }
        });
    }

    function updateSafeModeLabel(enabled) {
        const label = document.getElementById('safe-mode-label');
        if (label) label.textContent = enabled ? '开启' : '关闭';
    }

    // 定时爬取UI逻辑
    function updateAutoCrawlUI(enabled) {
        const timeField = document.getElementById('auto-crawl-time-field');
        const label = document.getElementById('auto-crawl-label');
        if (timeField) timeField.style.display = enabled ? 'block' : 'none';
        if (label) label.textContent = enabled ? '开启' : '关闭';
    }

    // 初始化事件监听
    document.addEventListener('DOMContentLoaded', function () {
        loadConfigValues();
        initSafeModeSwitch();
        loadTelegramTemplates();
        bindTemplateEditor();

        // 定时任务开关监听
        const autoCrawlSwitch = document.getElementById('cfg-auto-crawl');
        if (autoCrawlSwitch) {
            autoCrawlSwitch.addEventListener('change', function () {
                updateAutoCrawlUI(this.checked);
                updateAllStatusBadges();
            });
        }

        // 为系统配置项添加输入监听，实时更新badge
        const systemConfigInputs = ['cfg-proxy', 'cfg-bypass', 'cfg-token', 'cfg-chat-id', 'cfg-flaresolverr'];
        systemConfigInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', updateAllStatusBadges);
            }
        });

        // 为其他配置项添加变化监听
        const otherInputs = ['cfg-log-level', 'cfg-log-buffer-size', 'cfg-crawler-mode',
            'cfg-crawler-concurrency', 'cfg-crawler-thread-count',
            'cfg-async-delay-min', 'cfg-async-delay-max',
            'cfg-sync-delay-min', 'cfg-sync-delay-max',
            'cfg-auto-crawl-time'];
        otherInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('change', updateAllStatusBadges);
            }
        });

        // 初始化浮动保存条位置
        updateFloatingSaveBarPosition();

        // 监听侧边栏状态变化，调整浮动保存条位置
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            const observer = new MutationObserver(() => {
                updateFloatingSaveBarPosition();
            });
            observer.observe(sidebar, { attributes: true, attributeFilter: ['data-state'] });
        }

        // 监听窗口大小变化
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(updateFloatingSaveBarPosition, 100);
        });
    });

    // 更新浮动保存条位置以适应侧边栏状态
    function updateFloatingSaveBarPosition() {
        const floatingBar = document.querySelector('.floating-save-bar');
        if (!floatingBar) return;

        const sidebar = document.querySelector('.sidebar');
        if (!sidebar) return;

        const isCollapsed = sidebar.getAttribute('data-state') === 'collapsed';
        const windowWidth = window.innerWidth;
        const isDesktop = windowWidth > 1024;

        if (isDesktop) {
            // PC 端 (>1024px) - 侧边栏可见
            if (isCollapsed) {
                // 侧边栏收起时，使用 sidebar-width-icon
                const sidebarWidthIcon = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width-icon').trim();
                const safeAreaLeft = getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-left').trim() || '0px';
                floatingBar.style.left = `calc(${sidebarWidthIcon} + max(0px, ${safeAreaLeft}) + 1.5rem)`;
            } else {
                // 侧边栏展开时，使用 sidebar-width（CSS 默认值）
                floatingBar.style.left = '';
            }
        } else {
            // 平板端和移动端 (≤1024px) - 侧边栏隐藏，不需要调整
            floatingBar.style.left = '';
        }
    }
</script>
{% endblock %}