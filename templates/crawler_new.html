{% extends "base.html" %}

{% block title %}çˆ¬è™«æ§åˆ¶ - SHT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/crawler.css">
{% endblock %}

{% block content %}
<h1 class="page-title">çˆ¬è™«æ§åˆ¶</h1>

<div class="crawler-grid">
    <!-- çˆ¬è™«çŠ¶æ€å¡ç‰‡ -->
    <div class="crawler-card">
        <h3>çˆ¬è™«çŠ¶æ€</h3>
        <div class="status-item">
            <span>å½“å‰çŠ¶æ€</span>
            <span id="crawl-status" class="status-badge status-idle">ç©ºé—²</span>
        </div>
        <div class="status-item">
            <span>ä¸Šæ¬¡çˆ¬å–</span>
            <span id="last-crawl-time">-</span>
        </div>
        <div class="status-item">
            <span>å½“å‰è¿›åº¦</span>
            <span id="crawl-progress">-</span>
        </div>

        <!-- è¯¦ç»†è¿›åº¦ä¿¡æ¯ -->
        <div id="detailed-progress"
            style="display: none; margin-top: 1rem; padding: 1rem; background: var(--muted); border-radius: var(--border-radius);">
            <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                <strong id="current-section">-</strong>
            </div>
            <div style="font-size: 0.75rem; color: var(--muted-foreground);">
                <div id="page-progress">-</div>
                <div id="save-progress">-</div>
            </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-container" id="progress-container" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">å‡†å¤‡ä¸­...</div>
        </div>

        <div style="text-align: right; margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button id="crawlBtn" onclick="startCrawl()" class="btn btn-success">å¼€å§‹çˆ¬å–</button>
            <button id="pauseBtn" onclick="pauseCrawl()" class="btn btn-warning" style="display: none;">æš‚åœ</button>
            <button id="resumeBtn" onclick="resumeCrawl()" class="btn btn-success" style="display: none;">ç»§ç»­</button>
            <button id="stopBtn" onclick="stopCrawl()" class="btn btn-pink" style="display: none;">åœæ­¢</button>
            <button id="forceClearBtn" onclick="forceClearTask()" class="btn btn-destructive" style="display: none;"
                title="å¼ºåˆ¶é‡ç½®çˆ¬è™«çŠ¶æ€">å¼ºåˆ¶æ¸…é™¤</button>
        </div>
    </div>

    <!-- æœ€è¿‘çˆ¬å–ç»“æœå¡ç‰‡ -->
    <div class="crawler-card" id="crawl-results-card">
        <h3>æœ€è¿‘çˆ¬å–ç»“æœ</h3>
        <div id="crawl-results-content">
            <div style="text-align: center; color: var(--muted-foreground); padding: 2rem;">
                æš‚æ— çˆ¬å–è®°å½•
            </div>
        </div>
        <div style="text-align: right; margin-top: 1rem;">
            <button onclick="refreshCrawlResults()" class="btn btn-primary">åˆ·æ–°ç»“æœ</button>
            <button onclick="clearCrawlResults()" class="btn btn-destructive">æ¸…é™¤ç»“æœ</button>
        </div>
    </div>

    <!-- çˆ¬è™«é…ç½®å¡ç‰‡ -->
    <div class="crawler-card">
        <h3>æ‰‹åŠ¨çˆ¬å–é…ç½®</h3>

        <div class="config-options">
            <div class="config-field">
                <label for="dateMode">æ—¶é—´èŒƒå›´</label>
                <select id="dateMode" onchange="saveCrawlConfig()">
                    <option value="all">å…¨éƒ¨æ—¶é—´</option>
                    <option value="1day">ä¸€å¤©</option>
                    <option value="2days">ä¸¤å¤©</option>
                    <option value="1week">ä¸€å‘¨</option>
                    <option value="1month">ä¸€ä¸ªæœˆ</option>
                    <option value="3months">ä¸‰ä¸ªæœˆ</option>
                    <option value="6months">åŠå¹´</option>
                    <option value="1year">ä¸€å¹´</option>
                </select>
            </div>

            <div class="config-field">
                <label for="pageMode">é¡µæ•°æ¨¡å¼</label>
                <select id="pageMode" onchange="togglePageConfig()">
                    <option value="fixed">å›ºå®šé¡µæ•°</option>
                    <option value="full">å…¨éƒ¨é¡µé¢</option>
                    <option value="range">æŒ‡å®šèŒƒå›´</option>
                </select>
            </div>

            <div class="config-field" id="fixedPagesField">
                <label for="maxPages">æœ€å¤§é¡µæ•°</label>
                <input type="number" id="maxPages" min="1" max="100" value="3" onchange="saveCrawlConfig()">
            </div>

            <div class="config-field" id="rangePagesField" style="display: none;">
                <label>é¡µç èŒƒå›´</label>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="number" id="startPage" min="1" placeholder="èµ·å§‹" class="form-input" style="width: 80px;"
                        onchange="saveCrawlConfig()">
                    <span>è‡³</span>
                    <input type="number" id="endPage" min="1" placeholder="ç»“æŸ" class="form-input" style="width: 80px;"
                        onchange="saveCrawlConfig()">
                </div>
            </div>
        </div>

        <div style="text-align: right; margin-top: 1rem;">
            <button onclick="saveCrawlConfig(true)" class="btn btn-purple">æ‰‹åŠ¨ä¿å­˜é…ç½®</button>
            <span id="config-save-status"
                style="margin-left: 0.5rem; color: var(--muted-foreground); font-size: 0.875rem;"></span>
        </div>
    </div>
</div>

<!-- æ¿å—é€‰æ‹©åŒºåŸŸ -->
<div class="crawler-card" style="margin-top: 1.5rem;">
    <h3>é€‰æ‹©éœ€è¦çˆ¬å–çš„æ¿å—</h3>
    <div class="forum-selection">
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <button onclick="selectAllForums()" class="btn btn-pink">å…¨é€‰</button>
            <button onclick="clearAllForums()" class="btn btn-pink">æ¸…ç©º</button>
            <button onclick="loadForumCache()" class="btn btn-primary">
                è¯»å–ç¼“å­˜
            </button>
            <button onclick="loadForumList()" class="btn btn-purple">
                <span class="d-none d-sm-inline">åŒæ­¥SHTä¸»é¢˜å’Œé¡µæ•°</span>
                <span class="d-inline d-sm-none">åŒæ­¥è®ºå›</span>
            </button>
        </div>
        <div class="sync-warning-row">
            <span id="sync-warning" class="sync-warning-badge" style="display: none;">
                <span class="warning-icon">âš ï¸</span>
                <span class="warning-text">æ¿å—ä¿¡æ¯ä¸å®Œæ•´ï¼Œéœ€è¦åŒæ­¥</span>
            </span>
        </div>

        <div id="forum-list" class="forum-grid">
            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--muted-foreground);">
                æ­£åœ¨åŠ è½½æ¿å—åˆ—è¡¨...
            </div>
        </div>
    </div>
</div>

<!-- å¤±è´¥TIDç®¡ç†åŒºåŸŸ -->
<div class="crawler-card" style="margin-top: 1.5rem;">
    <h3>å¤±è´¥çš„TIDé‡è¯•ç®¡ç†</h3>
    <div class="failed-tid-content">
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="failed-tid-stats-section">
            <h4>å¤±è´¥ç»Ÿè®¡</h4>
            <div class="failed-tid-stats-grid">
                <div class="failed-tid-stat-item">
                    <span class="failed-tid-stat-number stat-pending" id="pending-count">-</span>
                    <span class="failed-tid-stat-label">å¾…é‡è¯•</span>
                </div>
                <div class="failed-tid-stat-item">
                    <span class="failed-tid-stat-number stat-success" id="success-count">-</span>
                    <span class="failed-tid-stat-label">å·²æˆåŠŸ</span>
                </div>
                <div class="failed-tid-stat-item">
                    <span class="failed-tid-stat-number stat-abandoned" id="abandoned-count">-</span>
                    <span class="failed-tid-stat-label">å·²æ”¾å¼ƒ</span>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†æ“ä½œ -->
        <div class="failed-tid-actions-section">

            <!-- é‡è¯•æ¨¡å¼é€‰æ‹©å™¨ -->
            <div class="retry-config-card">
                <div class="retry-config-container">
                    <div class="retry-config-header">
                        <i class="fas fa-cog"></i>
                        <h4>é‡è¯•æ¨¡å¼é…ç½®</h4>
                    </div>

                    <!-- æ¨¡å¼é€‰æ‹© -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="retry-mode-label">é€‰æ‹©æ¨¡å¼</label>
                        <div class="retry-mode-options">
                            <label class="radio-card">
                                <input type="radio" name="retryMode" value="single" checked
                                    onchange="toggleRetryModeOptions()">
                                <div class="radio-card-content">
                                    <div class="radio-card-title">å•è½®æ¨¡å¼</div>
                                    <div class="radio-card-desc">ä»…å¤„ç†ä¸€æ‰¹</div>
                                </div>
                            </label>
                            <label class="radio-card">
                                <input type="radio" name="retryMode" value="continuous"
                                    onchange="toggleRetryModeOptions()">
                                <div class="radio-card-content">
                                    <div class="radio-card-title">å¾ªç¯æ¨¡å¼</div>
                                    <div class="radio-card-desc">åˆ†æ‰¹å¤„ç†å…¨éƒ¨</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- å‚æ•°è®¾ç½® -->
                    <div class="retry-params-grid">
                        <div class="retry-param-field">
                            <label>æ¯è½®å¤„ç†æ•°é‡</label>
                            <div class="retry-param-input-wrap">
                                <input type="number" id="retryLimit" value="50" min="10" max="500" step="10"
                                    oninput="toggleRetryModeOptions()" class="form-control">
                                <span class="retry-param-unit">ä¸ª TID</span>
                            </div>
                        </div>

                        <div id="maxRoundsContainer" class="retry-param-field" style="display: none;">
                            <label>æœ€å¤šè½®æ•°</label>
                            <div class="retry-param-input-wrap">
                                <input type="number" id="maxRounds" value="20" min="1" max="100" step="1"
                                    oninput="toggleRetryModeOptions()" class="form-control">
                                <span class="retry-param-unit">è½®</span>
                            </div>
                        </div>
                    </div>

                    <!-- æ¨¡å¼è¯´æ˜ -->
                    <div id="modeTip" class="mode-tip-box">
                        <span class="mode-tip-emoji">ğŸ’¡</span>
                        <div class="mode-tip-text">
                            å•è½®æ¨¡å¼ï¼šå¤„ç† <strong>50</strong> ä¸ªTIDååœæ­¢
                        </div>
                    </div>
                </div>
            </div>

            <div class="failed-tid-actions">
                <button onclick="loadFailedTidsStats()" class="btn btn-primary">åˆ·æ–°ç»Ÿè®¡</button>
                <button onclick="retryFailedTids()" class="btn btn-success">æ‰¹é‡é‡è¯•</button>
                <button onclick="showFailedTidsList('pending')" class="btn btn-pink">æŸ¥çœ‹å¾…é‡è¯•</button>
                <button onclick="showFailedTidsList('abandoned')" class="btn btn-pink">æŸ¥çœ‹å·²æ”¾å¼ƒ</button>
                <button onclick="cleanupFailedTids()" class="btn btn-destructive">æ¸…ç†è®°å½•</button>
            </div>
        </div>
    </div>

    <!-- å¤±è´¥TIDåˆ—è¡¨ - åŠ å…¥åŠ¨ç”»å®¹å™¨ -->
    <div id="failed-tids-list-wrapper" class="collapsible-wrapper">
        <div class="collapsible-inner">
            <div id="failed-tids-list" class="failed-tid-list-container">
                <div class="failed-tid-list-header">
                    <h4 class="failed-tid-list-title">å¤±è´¥TIDåˆ—è¡¨</h4>
                </div>
                <div id="failed-tids-content" class="failed-tid-list-content">
                    <div style="padding: 2rem; text-align: center; color: var(--muted-foreground);">
                        æ­£åœ¨åŠ è½½...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    // çˆ¬è™«æ§åˆ¶æ¶æ„ v2.0.2 - 2026-01-16 (ä¿®å¤JavaScriptè¯­æ³•é”™è¯¯)
    // çˆ¬è™«é¡µé¢ç‰¹å®šçš„JavaScript
    let selectedForums = [];
    let isCrawling = false; // ã€æ–°å¢ã€‘å…¨å±€çˆ¬å–çŠ¶æ€è·Ÿè¸ª
    let statusCheckInterval = null;

    document.addEventListener('DOMContentLoaded', function () {
        // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€ç®¡ç†å™¨
        ButtonStateManager.init();

        // ä¼˜å…ˆä»æœåŠ¡å™¨åŠ è½½é…ç½®ï¼Œå¤±è´¥åˆ™ä½¿ç”¨æœ¬åœ°å­˜å‚¨
        Promise.all([
            loadCrawlConfigFromServer().catch(() => false),
            loadSelectedForumsFromServer().catch(() => false)
        ]).then(([configLoaded, forumsLoaded]) => {
            // å¦‚æœæœåŠ¡å™¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºé™çº§æ–¹æ¡ˆ
            if (!configLoaded) {
                loadCrawlConfigFromStorage();
            }
            if (!forumsLoaded) {
                loadSelectedForumsFromStorage();
            }
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è®ºå›åˆ—è¡¨ï¼ˆä»ç¼“å­˜ï¼‰
        loadCrawlConfig();
        checkCrawlStatus();

        // å»¶è¿ŸåŠ è½½è®ºå›ç¼“å­˜ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
        setTimeout(() => {
            console.log('å¼€å§‹è‡ªåŠ¨åŠ è½½è®ºå›ç¼“å­˜...');
            loadForumCache().catch(error => {
                console.error('è‡ªåŠ¨åŠ è½½è®ºå›ç¼“å­˜å¤±è´¥:', error);
                // å¦‚æœè‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                const forumListEl = document.getElementById('forum-list');
                if (forumListEl) {
                    forumListEl.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--muted-foreground);">
                        è‡ªåŠ¨åŠ è½½å¤±è´¥: ${error.message}<br>
                        <small>è¯·ç‚¹å‡»"è¯»å–ç¼“å­˜"æˆ–"åŒæ­¥è®ºå›"æŒ‰é’®æ‰‹åŠ¨åŠ è½½</small>
                    </div>
                `;
                }
            });
        }, 1000); // è¿›ä¸€æ­¥å¢åŠ å»¶è¿Ÿæ—¶é—´

        // è‡ªåŠ¨åŠ è½½å¤±è´¥TIDç»Ÿè®¡
        loadFailedTidsStats();

        // åŠ è½½æœ€è¿‘çš„çˆ¬å–ç»“æœ
        loadRecentCrawlResults();

        // å®šæœŸæ£€æŸ¥çˆ¬è™«çŠ¶æ€
        setInterval(checkCrawlStatus, 5000);

        // æ·»åŠ é…ç½®å˜åŒ–ç›‘å¬å™¨
        addConfigChangeListeners();
    });

    // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå®ç°è·¨æµè§ˆå™¨/æ ‡ç­¾é¡µé…ç½®åŒæ­¥
    document.addEventListener('visibilitychange', function () {
        if (!document.hidden) {
            console.log('é¡µé¢é‡æ–°å¯è§ï¼Œé‡æ–°åŠ è½½é…ç½®å’Œæ¿å—é€‰æ‹©');
            // é‡æ–°åŠ è½½é…ç½®å’Œæ¿å—é€‰æ‹©
            loadCrawlConfig();
            loadForumCache().catch(e => console.error('é‡æ–°åŠ è½½è®ºå›ç¼“å­˜å¤±è´¥:', e));
        }
    });

    // è¯»å–è®ºå›ç¼“å­˜
    async function loadForumCache() {
        const loadBtn = document.querySelector('button[onclick="loadForumCache()"]');
        let originalText = 'è¯»å–ç¼“å­˜';

        if (loadBtn) {
            originalText = loadBtn.innerHTML;
            loadBtn.innerHTML = 'è¯»å–ä¸­...';
            loadBtn.disabled = true;
        }

        try {
            console.log('å¼€å§‹è¯»å–è®ºå›ç¼“å­˜...');

            // å¹¶å‘è·å–è®ºå›ä¿¡æ¯å’Œæœ€æ–°ç»Ÿè®¡æ•°æ®
            const [forumResponse, statsResponse] = await Promise.all([
                fetch('/api/forum/info/batch?fast=false&force=false'), // è¯»å–ç¼“å­˜
                fetch('/api/stats/categories') // ä½¿ç”¨ç¼“å­˜çš„ç»Ÿè®¡æ•°æ®
            ]);

            console.log('APIå“åº”çŠ¶æ€:', {
                forum: forumResponse.status,
                stats: statsResponse.status
            });

            if (!forumResponse.ok) {
                throw new Error(`è®ºå›APIè¯·æ±‚å¤±è´¥: ${forumResponse.status} ${forumResponse.statusText}`);
            }

            if (!statsResponse.ok) {
                throw new Error(`ç»Ÿè®¡APIè¯·æ±‚å¤±è´¥: ${statsResponse.status} ${statsResponse.statusText}`);
            }

            const forumData = await forumResponse.json();
            const statsData = await statsResponse.json();

            console.log('è®ºå›æ•°æ®:', forumData);
            console.log('ç»Ÿè®¡æ•°æ®:', statsData);

            // å¤„ç†ç»Ÿè®¡æ•°æ®çš„å“åº”æ ¼å¼ï¼ˆå¯èƒ½åŒ…è£…åœ¨ data å­—æ®µä¸­ï¼‰
            const processedStatsData = statsData.data !== undefined ? statsData.data : statsData;
            console.log('å¤„ç†åçš„ç»Ÿè®¡æ•°æ®:', processedStatsData);

            if (forumData.status === 'success' && forumData.data) {
                updateForumList(forumData.data, statsData);
                showToast('è®ºå›ç¼“å­˜è¯»å–æˆåŠŸï¼Œæœ¬åœ°ä¸»é¢˜æ•°å·²æ›´æ–°', 'success');

                // æ˜¾ç¤ºç¼“å­˜ä¿¡æ¯
                if (forumData.cached) {
                    const forumCount = Object.keys(forumData.data).length;
                    console.log(`ä»ç¼“å­˜è¯»å– ${forumCount} ä¸ªæ¿å—ä¿¡æ¯`);
                    if (forumCount > 0) {
                        showToast(`å·²ä»ç¼“å­˜è¯»å– ${forumCount} ä¸ªæ¿å—ä¿¡æ¯`, 'info');
                    } else {
                        showToast('ç¼“å­˜ä¸ºç©ºï¼Œè¯·ç‚¹å‡»"åŒæ­¥è®ºå›"è·å–æœ€æ–°æ•°æ®', 'warning');
                    }
                }
            } else {
                const errorMsg = forumData.message || 'æœªçŸ¥é”™è¯¯';
                console.error('è®ºå›æ•°æ®è·å–å¤±è´¥:', errorMsg);
                showToast('è¯»å–è®ºå›ç¼“å­˜å¤±è´¥: ' + errorMsg, 'error');

                // æ˜¾ç¤ºé”™è¯¯æç¤º
                const forumListEl = document.getElementById('forum-list');
                if (forumListEl) {
                    forumListEl.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--muted-foreground);">
                        è¯»å–å¤±è´¥: ${errorMsg}<br>
                        <small>è¯·ç‚¹å‡»"è¯»å–ç¼“å­˜"é‡è¯•æˆ–"åŒæ­¥è®ºå›"è·å–æœ€æ–°æ•°æ®</small>
                    </div>
                `;
                }
            }
        } catch (error) {
            console.error('è¯»å–è®ºå›ç¼“å­˜å¤±è´¥:', error);
            showToast('è¯»å–è®ºå›ç¼“å­˜å¤±è´¥: ' + error.message, 'error');

            // é”™è¯¯æ—¶æ˜¾ç¤ºæç¤ºä¿¡æ¯
            const forumListEl = document.getElementById('forum-list');
            if (forumListEl) {
                forumListEl.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--muted-foreground);">
                    ç½‘ç»œé”™è¯¯: ${error.message}<br>
                    <small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</small>
                </div>
            `;
            }
        } finally {
            if (loadBtn) {
                loadBtn.innerHTML = originalText;
                loadBtn.disabled = false;
            }
        }
    }

    // åŠ è½½è®ºå›åˆ—è¡¨ï¼ˆå¼ºåˆ¶åŒæ­¥ï¼‰
    async function loadForumList() {
        console.log('='.repeat(60));
        console.log('ğŸ”„ [loadForumList] å¼€å§‹æ‰§è¡ŒåŒæ­¥æ“ä½œ');
        console.log('='.repeat(60));

        const loadBtn = document.querySelector('button[onclick="loadForumList()"]');
        const originalText = loadBtn.innerHTML;

        try {
            console.log('ğŸ”˜ [loadForumList] æŒ‰é’®çŠ¶æ€è®¾ç½®ä¸º"åŒæ­¥ä¸­..."');
            loadBtn.innerHTML = 'åŒæ­¥ä¸­...';
            loadBtn.disabled = true;

            console.log('ğŸŒ [loadForumList] å‘é€APIè¯·æ±‚...');
            console.log('   - URL1: /api/forum/info/batch?fast=false&force=true');
            console.log('   - URL2: /api/stats/categories');

            const [forumResponse, statsResponse] = await Promise.all([
                fetch('/api/forum/info/batch?fast=false&force=true'), // å¼ºåˆ¶åˆ·æ–°
                fetch('/api/stats/categories')
            ]);

            console.log('âœ… [loadForumList] æ”¶åˆ°å“åº”:', {
                forumStatus: forumResponse.status,
                statsStatus: statsResponse.status
            });

            const forumResult = await forumResponse.json();
            const statsResult = await statsResponse.json();

            if (forumResult.status === 'success' && forumResult.data) {
                updateForumList(forumResult.data, statsResult);
                showToast('æ¿å—ä¿¡æ¯åŒæ­¥æˆåŠŸï¼ˆç¼“å­˜å·²æ›´æ–°ï¼Œ72å°æ—¶å†…æœ‰æ•ˆï¼‰', 'success');
            } else {
                showToast('åŒæ­¥å¤±è´¥: ' + forumResult.message, 'error');
                // æ˜¾ç¤ºè­¦å‘Šæ ‡è¯†
                showSyncWarning(forumResult.message);
            }
        } catch (error) {
            console.error('åŒæ­¥æ¿å—ä¿¡æ¯å¤±è´¥:', error);
            showToast('åŒæ­¥å¤±è´¥: ' + error.message, 'error');
            showSyncWarning('ç½‘ç»œè¿æ¥å¤±è´¥æˆ–æœåŠ¡å™¨é”™è¯¯');
        } finally {
            loadBtn.innerHTML = originalText;
            loadBtn.disabled = false;
        }
    }

    // æ›´æ–°è®ºå›åˆ—è¡¨æ˜¾ç¤º
    function updateForumList(forums, statsResult = []) {
        console.log('updateForumList è¢«è°ƒç”¨:', { forums, statsResult });

        const forumListEl = document.getElementById('forum-list');
        if (!forumListEl) {
            console.error('æ‰¾ä¸åˆ° forum-list å…ƒç´ ');
            return;
        }

        const categoryStats = {};

        // æ£€æŸ¥forumså‚æ•°æ˜¯å¦æœ‰æ•ˆ
        if (!forums || typeof forums !== 'object') {
            console.warn('è®ºå›æ•°æ®æ— æ•ˆ:', forums);
            forumListEl.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--muted-foreground);">
                è®ºå›æ•°æ®æ— æ•ˆï¼Œè¯·ç‚¹å‡»"è¯»å–ç¼“å­˜"æˆ–"åŒæ­¥è®ºå›"æŒ‰é’®è·å–æ•°æ®
            </div>
        `;
            return;
        }

        const forumKeys = Object.keys(forums);
        if (forumKeys.length === 0) {
            console.warn('è®ºå›æ•°æ®ä¸ºç©º');
            forumListEl.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--muted-foreground);">
                æš‚æ— æ¿å—æ•°æ®ï¼Œè¯·ç‚¹å‡»"è¯»å–ç¼“å­˜"æˆ–"åŒæ­¥è®ºå›"æŒ‰é’®è·å–æ•°æ®
            </div>
        `;
            return;
        }

        console.log(`å‡†å¤‡æ˜¾ç¤º ${forumKeys.length} ä¸ªæ¿å—`);

        // åŠ è½½ä¿å­˜çš„é€‰ä¸­çŠ¶æ€
        loadSelectedForumsFromStorage();

        // å¤„ç†ç»Ÿè®¡æ•°æ®ï¼Œå°†æ¿å—åç§°æ˜ å°„åˆ°æ•°é‡
        const statsPayload = Array.isArray(statsResult)
            ? statsResult
            : (statsResult && Array.isArray(statsResult.data) ? statsResult.data : []);

        if (Array.isArray(statsPayload)) {
            statsPayload.forEach(stat => {
                const sectionName = stat.section || stat.name;
                if (sectionName && sectionName !== 'æœªçŸ¥') {
                    const countValue = stat.count !== undefined
                        ? stat.count
                        : (stat.resource_count !== undefined ? stat.resource_count : 0);
                    categoryStats[sectionName] = countValue;
                }
            });
            console.log('æœ¬åœ°ç»Ÿè®¡æ•°æ®:', categoryStats);
            console.log('ç»Ÿè®¡æ•°æ®è¯¦æƒ…:', statsPayload);
        } else {
            console.warn('ç»Ÿè®¡æ•°æ®æ ¼å¼å¼‚å¸¸:', statsResult);
        }

        forumListEl.innerHTML = '';

        let renderedCount = 0;
        Object.entries(forums).forEach(([fid, info]) => {
            const forumCard = document.createElement('div');
            forumCard.className = 'forum-card';
            forumCard.dataset.fid = fid;

            // åº”ç”¨ä¿å­˜çš„é€‰ä¸­çŠ¶æ€
            if (selectedForums.includes(fid)) {
                forumCard.classList.add('selected');
            }

            // è·å–æœ¬åœ°å·²çˆ¬å–çš„ä¸»é¢˜æ•°
            const localCount = categoryStats[info.name] || 0;
            console.log(`æ¿å— "${info.name}" æœ¬åœ°ä¸»é¢˜æ•°: ${localCount}`, {
                categoryStats,
                infoName: info.name,
                hasMatch: info.name in categoryStats
            });

            // ä¿®å¤å­—æ®µåç§°ï¼šä½¿ç”¨total_topicså’Œtotal_pagesè€Œä¸æ˜¯topicså’Œpages
            // æ³¨æ„ï¼šnullã€undefined ä¸è½¬æ¢ä¸º 0ï¼Œä¿æŒåŸå€¼ç”¨äºåˆ¤æ–­
            const remoteTopics = info.total_topics !== undefined && info.total_topics !== null ? info.total_topics : (info.topics !== undefined && info.topics !== null ? info.topics : null);
            const remotePages = info.total_pages !== undefined && info.total_pages !== null ? info.total_pages : (info.pages !== undefined && info.pages !== null ? info.pages : null);

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºè­¦å‘Šï¼ˆä¸»é¢˜æ•°æˆ–é¡µæ•°ä¸ºnullï¼‰
            const hasWarning = remoteTopics === null || remotePages === null;

            forumCard.innerHTML = `
            <div class="forum-card-header">
                <div class="forum-name">
                    ${info.name || `æ¿å—${fid}`}
                    ${hasWarning ? '<span style="color: #f59e0b; margin-left: 0.5rem;" title="åŒæ­¥æ•°æ®ä¸å®Œæ•´"></span>' : ''}
                </div>
                <div class="forum-fid">FID: ${fid}</div>
            </div>
            <div class="forum-stats">
                <div>è¿œç¨‹ä¸»é¢˜: ${remoteTopics !== null ? remoteTopics : 'æœªçŸ¥'}</div>
                <div>è¿œç¨‹é¡µæ•°: ${remotePages !== null ? remotePages : 'æœªçŸ¥'}</div>
                <div>æœ¬åœ°ä¸»é¢˜: <strong style="color: var(--emerald-500);">${localCount}</strong></div>
            </div>
        `;

            forumCard.addEventListener('click', () => toggleForumSelection(fid, forumCard));
            forumListEl.appendChild(forumCard);
            renderedCount++;
        });

        console.log(`è®ºå›åˆ—è¡¨æ›´æ–°å®Œæˆ: æ¸²æŸ“äº† ${renderedCount} ä¸ªæ¿å—, å·²é€‰ä¸­: ${selectedForums.length} ä¸ª`);

        // ã€æ–°å¢ã€‘æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¿å—ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ˜¾ç¤º/éšè—è­¦å‘Šå¾½ç« 
        checkAndUpdateSyncWarning(forums);
    }

    // ã€æ–°å¢ã€‘æ£€æŸ¥å¹¶æ›´æ–°åŒæ­¥è­¦å‘Šå¾½ç« 
    function checkAndUpdateSyncWarning(forums) {
        const warningBadge = document.getElementById('sync-warning');
        if (!warningBadge) return;

        // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¿å—çš„ä¸»é¢˜æ•°æˆ–é¡µæ•°ä¸ºnull
        let hasIncompleteData = false;
        if (forums && typeof forums === 'object') {
            for (const [fid, info] of Object.entries(forums)) {
                const remoteTopics = info.total_topics !== undefined && info.total_topics !== null ? info.total_topics : (info.topics !== undefined && info.topics !== null ? info.topics : null);
                const remotePages = info.total_pages !== undefined && info.total_pages !== null ? info.total_pages : (info.pages !== undefined && info.pages !== null ? info.pages : null);

                if (remoteTopics === null || remotePages === null) {
                    hasIncompleteData = true;
                    break;
                }
            }
        }

        // æ˜¾ç¤ºæˆ–éšè—è­¦å‘Šå¾½ç« 
        if (hasIncompleteData) {
            warningBadge.style.display = 'inline-flex';
        } else {
            warningBadge.style.display = 'none';
        }
    }

    // æ˜¾ç¤ºåŒæ­¥è­¦å‘Š
    function showSyncWarning(message) {
        const warningEl = document.createElement('div');
        warningEl.className = 'alert alert-warning mt-4';
        warningEl.innerHTML = `
        <strong>åŒæ­¥è­¦å‘Š:</strong> ${message}
        <br><small>éƒ¨åˆ†æ¿å—ä¿¡æ¯å¯èƒ½ä¸å®Œæ•´ï¼Œå»ºè®®ç¨åé‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥</small>
    `;

        // æ’å…¥åˆ°æ¿å—é€‰æ‹©åŒºåŸŸåé¢
        const forumSection = document.querySelector('.forum-selection');
        forumSection.appendChild(warningEl);

        // 5ç§’åè‡ªåŠ¨ç§»é™¤è­¦å‘Š
        setTimeout(() => {
            if (warningEl.parentNode) {
                warningEl.parentNode.removeChild(warningEl);
            }
        }, 5000);
    }

    // ä¿å­˜é€‰ä¸­çŠ¶æ€åˆ°æœåŠ¡å™¨
    async function saveSelectedForums() {
        try {
            // åŒæ—¶ä¿å­˜åˆ°localStorageï¼ˆå¿«é€Ÿè®¿é—®ï¼‰å’ŒæœåŠ¡å™¨ï¼ˆè·¨è®¾å¤‡åŒæ­¥ï¼‰
            localStorage.setItem('selectedForums', JSON.stringify(selectedForums));

            // ä¿å­˜åˆ°æœåŠ¡å™¨
            const response = await fetch('/api/crawl/selected-forums', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    selected_forums: selectedForums
                })
            });

            if (response.ok) {
                console.log('é€‰ä¸­è®ºå›å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
            } else {
                console.warn('æœåŠ¡å™¨è®ºå›é€‰æ‹©ä¿å­˜å¤±è´¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°');
            }
        } catch (error) {
            console.warn('æ— æ³•ä¿å­˜é€‰ä¸­çŠ¶æ€:', error);
        }
    }

    // ä»æœåŠ¡å™¨åŠ è½½é€‰ä¸­çŠ¶æ€
    async function loadSelectedForumsFromServer() {
        try {
            const response = await fetch('/api/crawl/selected-forums');
            if (response.ok) {
                const data = await response.json();
                if (data.status === 'success' && Array.isArray(data.selected_forums)) {
                    selectedForums = data.selected_forums;
                    updateForumSelection();
                    console.log('å·²ä»æœåŠ¡å™¨åŠ è½½é€‰ä¸­çŠ¶æ€:', selectedForums);
                    return true;
                }
            }
        } catch (error) {
            console.warn('ä»æœåŠ¡å™¨åŠ è½½è®ºå›é€‰æ‹©å¤±è´¥:', error);
        }
        return false;
    }

    // ä»localStorageåŠ è½½é€‰ä¸­çŠ¶æ€ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
    function loadSelectedForumsFromStorage() {
        try {
            const saved = localStorage.getItem('selectedForums');
            if (saved) {
                selectedForums = JSON.parse(saved);
                updateForumSelection();
                console.log('å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½é€‰ä¸­çŠ¶æ€:', selectedForums);
                return true;
            }
        } catch (error) {
            console.warn('æ— æ³•åŠ è½½æœ¬åœ°é€‰ä¸­çŠ¶æ€:', error);
            selectedForums = [];
        }
        return false;
    }

    // æ³¨æ„ï¼šsaveCrawlConfig å‡½æ•°çš„å®Œæ•´å®ç°åœ¨ä¸‹æ–¹ï¼ˆline 1238ï¼‰ï¼Œè¿™é‡Œä¸é‡å¤å®šä¹‰

    // ä»æœåŠ¡å™¨åŠ è½½çˆ¬å–é…ç½®
    async function loadCrawlConfigFromServer() {
        try {
            const response = await fetch('/api/crawl/config');
            if (response.ok) {
                const data = await response.json();
                const config = data.config || {};

                if (config.date_mode) {
                    document.getElementById('dateMode').value = config.date_mode;
                }
                if (config.page_mode) {
                    document.getElementById('pageMode').value = config.page_mode;
                    togglePageConfig();
                }
                if (config.max_pages) {
                    document.getElementById('maxPages').value = config.max_pages;
                }
                if (config.page_range && Array.isArray(config.page_range) && config.page_range.length === 2) {
                    document.getElementById('startPage').value = config.page_range[0];
                    document.getElementById('endPage').value = config.page_range[1];
                }

                console.log('å·²ä»æœåŠ¡å™¨åŠ è½½çˆ¬å–é…ç½®:', config);
                return true;
            }
        } catch (error) {
            console.warn('ä»æœåŠ¡å™¨åŠ è½½é…ç½®å¤±è´¥:', error);
        }
        return false;
    }

    // ä»localStorageåŠ è½½çˆ¬å–é…ç½®ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
    function loadCrawlConfigFromStorage() {
        try {
            const saved = localStorage.getItem('crawlConfig');
            if (saved) {
                const config = JSON.parse(saved);

                if (config.date_mode) {
                    document.getElementById('dateMode').value = config.date_mode;
                }
                if (config.page_mode) {
                    document.getElementById('pageMode').value = config.page_mode;
                    togglePageConfig();
                }
                if (config.max_pages) {
                    document.getElementById('maxPages').value = config.max_pages;
                }
                if (config.page_range && Array.isArray(config.page_range) && config.page_range.length === 2) {
                    document.getElementById('startPage').value = config.page_range[0];
                    document.getElementById('endPage').value = config.page_range[1];
                }
                console.log('å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½çˆ¬å–é…ç½®:', config);
                return true;
            }
        } catch (error) {
            console.warn('æ— æ³•åŠ è½½æœ¬åœ°çˆ¬å–é…ç½®:', error);
        }
        return false;
    }

    // æ·»åŠ é…ç½®å˜åŒ–ç›‘å¬å™¨
    function addConfigChangeListeners() {
        // ç›‘å¬æ‰€æœ‰é…ç½®é¡¹çš„å˜åŒ–
        const configElements = ['dateMode', 'pageMode', 'maxPages', 'startPage', 'endPage'];
        configElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', saveCrawlConfig);
            }
        });
    }

    // åˆ‡æ¢è®ºå›é€‰æ‹©
    function toggleForumSelection(fid, cardElement) {
        const index = selectedForums.indexOf(fid);

        if (index > -1) {
            selectedForums.splice(index, 1);
            cardElement.classList.remove('selected');
        } else {
            selectedForums.push(fid);
            cardElement.classList.add('selected');
        }

        // ä¿å­˜é€‰ä¸­çŠ¶æ€
        saveSelectedForums();
    }

    // å…¨é€‰è®ºå›
    function selectAllForums() {
        const forumCards = document.querySelectorAll('.forum-card');
        selectedForums = [];

        forumCards.forEach(card => {
            const fid = card.dataset.fid;
            if (fid) {
                selectedForums.push(fid);
                card.classList.add('selected');
            }
        });

        // ä¿å­˜é€‰ä¸­çŠ¶æ€
        saveSelectedForums();
    }

    // æ¸…ç©ºé€‰æ‹©
    function clearAllForums() {
        selectedForums = [];
        document.querySelectorAll('.forum-card').forEach(card => {
            card.classList.remove('selected');
        });

        // ä¿å­˜é€‰ä¸­çŠ¶æ€
        saveSelectedForums();
    }

    // åˆ‡æ¢é¡µæ•°é…ç½®æ˜¾ç¤º
    function togglePageConfig() {
        const pageMode = document.getElementById('pageMode').value;
        const fixedField = document.getElementById('fixedPagesField');
        const rangeField = document.getElementById('rangePagesField');

        if (pageMode === 'fixed') {
            fixedField.style.display = 'flex';
            rangeField.style.display = 'none';
        } else if (pageMode === 'range') {
            fixedField.style.display = 'none';
            rangeField.style.display = 'flex';
        } else { // full
            fixedField.style.display = 'none';
            rangeField.style.display = 'none';
        }

        // è‡ªåŠ¨ä¿å­˜é…ç½®
        saveCrawlConfig();
    }

    // åŠ è½½çˆ¬è™«é…ç½®
    let isLoadingConfig = false;
    async function loadCrawlConfig() {
        try {
            isLoadingConfig = true; // æ ‡è®°æ­£åœ¨åŠ è½½é…ç½®
            const response = await fetch('/api/crawl/config');
            const result = await response.json();

            // API è¿”å›æ ¼å¼ä¸º { status: 'success', data: {...} }
            const config = result.data || result;

            if (config.date_mode) {
                document.getElementById('dateMode').value = config.date_mode;
            }
            if (config.page_mode) {
                document.getElementById('pageMode').value = config.page_mode;
                togglePageConfig();
            }
            if (config.max_pages) {
                document.getElementById('maxPages').value = config.max_pages;
            }
            if (config.page_range && Array.isArray(config.page_range) && config.page_range.length === 2) {
                document.getElementById('startPage').value = config.page_range[0];
                document.getElementById('endPage').value = config.page_range[1];
            }
            if (config.selected_forums) {
                selectedForums = config.selected_forums;
                // æ›´æ–°UIé€‰æ‹©çŠ¶æ€
                updateForumSelection();
            }

            console.log('âœ“ çˆ¬è™«é…ç½®å·²åŠ è½½ï¼ˆæ¥è‡ªæœåŠ¡å™¨ï¼‰');
        } catch (error) {
            console.error('åŠ è½½çˆ¬è™«é…ç½®å¤±è´¥:', error);
        } finally {
            isLoadingConfig = false; // åŠ è½½å®Œæˆ
        }
    }

    // æ›´æ–°è®ºå›é€‰æ‹©UI
    function updateForumSelection() {
        document.querySelectorAll('.forum-card').forEach(card => {
            const fid = card.dataset.fid;
            if (selectedForums.includes(fid)) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    }

    // ä¿å­˜çˆ¬è™«é…ç½®
    let saveConfigTimeout = null;
    async function saveCrawlConfig(showNotification = false) {
        // å¦‚æœæ­£åœ¨åŠ è½½é…ç½®ï¼Œè·³è¿‡ä¿å­˜
        if (isLoadingConfig) {
            return;
        }

        // é˜²æŠ–ï¼šæ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (saveConfigTimeout) {
            clearTimeout(saveConfigTimeout);
        }

        // å»¶è¿Ÿä¿å­˜ï¼ˆé¿å…é¢‘ç¹è¯·æ±‚ï¼‰
        saveConfigTimeout = setTimeout(async () => {
            try {
                const statusEl = document.getElementById('config-save-status');
                if (statusEl) {
                    statusEl.textContent = 'ä¿å­˜ä¸­...';
                    statusEl.style.color = 'var(--muted-foreground)';
                }

                const config = {
                    selected_forums: selectedForums,
                    date_mode: document.getElementById('dateMode').value,
                    page_mode: document.getElementById('pageMode').value,
                    max_pages: parseInt(document.getElementById('maxPages').value)
                };

                // å¦‚æœæ˜¯èŒƒå›´æ¨¡å¼ï¼Œæ·»åŠ  page_rangeå‚æ•°
                if (config.page_mode === 'range') {
                    const startPage = document.getElementById('startPage').value;
                    const endPage = document.getElementById('endPage').value;
                    if (startPage && endPage) {
                        config.page_range = [parseInt(startPage), parseInt(endPage)];
                    }
                }

                const response = await fetch('/api/crawl/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    if (statusEl) {
                        statusEl.textContent = 'âœ“ å·²ä¿å­˜';
                        statusEl.style.color = 'var(--emerald-500)';
                        // 3ç§’åæ¸…é™¤çŠ¶æ€
                        setTimeout(() => {
                            statusEl.textContent = '';
                        }, 3000);
                    }
                    // åªæœ‰æ‰‹åŠ¨ç‚¹å‡»ä¿å­˜æŒ‰é’®æ—¶æ‰æ˜¾ç¤º toast
                    if (showNotification) {
                        showToast('çˆ¬è™«é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    }
                } else {
                    if (statusEl) {
                        statusEl.textContent = 'âœ— ä¿å­˜å¤±è´¥';
                        statusEl.style.color = 'var(--rose-500)';
                    }
                    if (showNotification) {
                        showToast('ä¿å­˜é…ç½®å¤±è´¥', 'error');
                    }
                }
            } catch (error) {
                console.error('ä¿å­˜çˆ¬è™«é…ç½®å¤±è´¥:', error);
                const statusEl = document.getElementById('config-save-status');
                if (statusEl) {
                    statusEl.textContent = 'âœ— ä¿å­˜å¤±è´¥';
                    statusEl.style.color = 'var(--rose-500)';
                }
                if (showNotification) {
                    showToast('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
                }
            }
        }, 500); // 500ms é˜²æŠ–
    }

    // ã€æ–°å¢ã€‘å®æ—¶åŒæ­¥çˆ¬è™«UIçŠ¶æ€ï¼ˆç”± base.html å®šæœŸè°ƒç”¨ï¼‰
    window.syncCrawlerUI = function (config) {
        if (isLoadingConfig || (typeof isCrawling !== 'undefined' && isCrawling)) {
            return; // å¦‚æœæ­£åœ¨åŠ è½½æˆ–æ­£åœ¨çˆ¬å–ï¼Œä¸è‡ªåŠ¨åŒæ­¥é…ç½®ï¼Œé¿å…å†²çª
        }

        let changed = false;

        // 1. åŒæ­¥æ¿å—é€‰æ‹©
        if (config.CRAWL_FORUMS && Array.isArray(config.CRAWL_FORUMS)) {
            const newForums = config.CRAWL_FORUMS;
            // æ¯”è¾ƒæ˜¯å¦æœ‰å˜åŒ–
            if (JSON.stringify(newForums.sort()) !== JSON.stringify(selectedForums.sort())) {
                console.log('ğŸ”„ æ£€æµ‹åˆ°æ¿å—é€‰æ‹©å˜åŒ–ï¼Œä»æœåŠ¡å™¨åŒæ­¥');
                selectedForums = newForums;
                updateForumSelection();
                changed = true;
            }
        }

        // 2. åŒæ­¥çˆ¬è™«å‚æ•°
        const params = [
            { id: 'dateMode', key: 'CRAWL_DATE_MODE' },
            { id: 'pageMode', key: 'CRAWL_PAGE_MODE' },
            { id: 'maxPages', key: 'CRAWL_MAX_PAGES' }
        ];

        params.forEach(p => {
            const el = document.getElementById(p.id);
            if (el && config[p.key] !== undefined) {
                const newValue = String(config[p.key]);
                if (el.value !== newValue && document.activeElement !== el) {
                    console.log(`ğŸ”„ åŒæ­¥é…ç½® ${p.id}: ${el.value} -> ${newValue}`);
                    el.value = newValue;
                    if (p.id === 'pageMode') togglePageConfig();
                    changed = true;
                }
            }
        });

        // åŒæ­¥ page_range
        if (config.CRAWL_PAGE_MODE === 'range' && config.CRAWL_PAGE_RANGE && Array.isArray(config.CRAWL_PAGE_RANGE) && config.CRAWL_PAGE_RANGE.length === 2) {
            const startPageEl = document.getElementById('startPage');
            const endPageEl = document.getElementById('endPage');
            const newStart = String(config.CRAWL_PAGE_RANGE[0]);
            const newEnd = String(config.CRAWL_PAGE_RANGE[1]);

            if (startPageEl && endPageEl) {
                if (startPageEl.value !== newStart && document.activeElement !== startPageEl) {
                    startPageEl.value = newStart;
                    changed = true;
                }
                if (endPageEl.value !== newEnd && document.activeElement !== endPageEl) {
                    endPageEl.value = newEnd;
                    changed = true;
                }
            }
        }

        if (changed) {
            // console.log('âœ“ çˆ¬è™«é…ç½®åŒæ­¥å®Œæˆ');
        }
    };

    // æ£€æŸ¥çˆ¬è™«çŠ¶æ€
    async function checkCrawlStatus() {
        try {
            const response = await fetch('/api/crawl/status');
            const status = await response.json();

            // ã€è°ƒè¯•ã€‘è¾“å‡ºå®Œæ•´çš„çŠ¶æ€ä¿¡æ¯
            console.log('ğŸ” [checkCrawlStatus] æ”¶åˆ°çŠ¶æ€:', {
                is_crawling: status.is_crawling,
                is_paused: status.is_paused,
                message: status.message,
                timestamp: new Date().toLocaleTimeString()
            });

            const statusEl = document.getElementById('crawl-status');
            const lastTimeEl = document.getElementById('last-crawl-time');
            const progressEl = document.getElementById('crawl-progress');
            const crawlBtn = document.getElementById('crawlBtn');
            const stopBtn = document.getElementById('stopBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const forceClearBtn = document.getElementById('forceClearBtn');
            const progressContainer = document.getElementById('progress-container');
            const detailedProgress = document.getElementById('detailed-progress');

            // æ›´æ–°çŠ¶æ€
            statusEl.textContent = status.message || 'ç©ºé—²';
            statusEl.className = `status-badge ${status.is_crawling ? 'status-running' : (status.is_paused ? 'status-paused' : 'status-idle')}`;

            if (status.last_crawl_time) {
                lastTimeEl.textContent = new Date(status.last_crawl_time).toLocaleString();
            }

            // ã€ä¿®å¤ã€‘é˜²æ­¢æŒ‰é’®çŠ¶æ€æŠ–åŠ¨ - ä½¿ç”¨çŠ¶æ€é”å®šæœºåˆ¶
            // å¦‚æœæŒ‰é’®æ­£åœ¨æ‰§è¡Œæ“ä½œï¼ˆæ˜¾ç¤º"æ­£åœ¨æš‚åœ..."ç­‰ï¼‰ï¼Œä¸æ›´æ–°æŒ‰é’®çŠ¶æ€
            // pauseBtn å’Œ resumeBtn å·²åœ¨ä¸Šæ–¹å£°æ˜ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
            const isPauseInProgress = pauseBtn.textContent.includes('æ­£åœ¨');
            const isResumeInProgress = resumeBtn.textContent.includes('æ­£åœ¨');

            // æ›´æ–°æŒ‰é’®çŠ¶æ€ - ã€ä¿®å¤ã€‘ä¼˜å…ˆæ£€æŸ¥is_pausedçŠ¶æ€ï¼Œå¹¶é˜²æ­¢æŠ–åŠ¨
            if (status.is_paused) {
                console.log('â¸ï¸ [checkCrawlStatus] æ£€æµ‹åˆ°æš‚åœçŠ¶æ€ï¼Œæ›´æ–°æŒ‰é’®...');
                // æš‚åœçŠ¶æ€ï¼šæ˜¾ç¤º"ç»§ç»­"å’Œ"åœæ­¢"æŒ‰é’®
                isCrawling = false; // æš‚åœçŠ¶æ€ä¸è®¤ä¸ºæ˜¯"æ­£åœ¨çˆ¬å–"
                crawlBtn.style.display = 'none';
                stopBtn.style.display = 'inline-flex';
                pauseBtn.style.display = 'none'; // æš‚åœæ—¶ä¸æ˜¾ç¤ºæš‚åœæŒ‰é’®
                resumeBtn.style.display = 'inline-flex';

                // åªæœ‰åœ¨ä¸æ˜¯"æ­£åœ¨æ¢å¤"çŠ¶æ€æ—¶æ‰æ›´æ–°æŒ‰é’®
                if (!isResumeInProgress) {
                    resumeBtn.disabled = false;
                    resumeBtn.textContent = 'ç»§ç»­';
                }
                stopBtn.disabled = false;
                stopBtn.textContent = 'åœæ­¢';

                // é‡ç½®æš‚åœæŒ‰é’®æ–‡æœ¬
                pauseBtn.textContent = 'æš‚åœ';
                progressContainer.style.display = 'block';
                detailedProgress.style.display = 'block';
                forceClearBtn.style.display = 'inline-flex';

                // æš‚åœçŠ¶æ€ä¸‹ä¹Ÿä¿æŒè¾ƒé«˜é¢‘ç‡åˆ·æ–°ï¼Œä»¥ä¾¿ç”¨æˆ·çœ‹åˆ°çŠ¶æ€å˜åŒ–
                if (!statusCheckInterval || statusCheckInterval._delay > 2000) {
                    if (statusCheckInterval) clearInterval(statusCheckInterval);
                    const itv = setInterval(checkCrawlStatus, 1000); // ç§’çº§åˆ·æ–°
                    itv._delay = 1000;
                    statusCheckInterval = itv;
                    console.log('â¸ï¸ ä¾¦æµ‹åˆ°çˆ¬å–ä»»åŠ¡æš‚åœï¼Œå·²æå‡çŠ¶æ€åˆ·æ–°é¢‘ç‡åˆ° 1s');
                }

                // æ›´æ–°è¿›åº¦æ˜¾ç¤ºä¸ºæš‚åœçŠ¶æ€
                document.getElementById('current-section').textContent = 'çˆ¬è™«å·²æš‚åœ';
                // å…¶ä»–è¿›åº¦ä¿¡æ¯ä¿æŒä¸å˜ï¼Œæˆ–è€…æ˜¾ç¤ºä¸Šæ¬¡æ›´æ–°çš„å€¼
            } else if (status.is_crawling) {
                // è¿è¡ŒçŠ¶æ€ï¼šæ˜¾ç¤º"æš‚åœ"å’Œ"åœæ­¢"æŒ‰é’®
                isCrawling = true; // æ›´æ–°å…¨å±€çŠ¶æ€
                crawlBtn.style.display = 'none';
                stopBtn.style.display = 'inline-flex';
                pauseBtn.style.display = 'inline-flex';
                resumeBtn.style.display = 'none'; // çˆ¬å–ä¸­ä¸æ˜¾ç¤ºæ¢å¤æŒ‰é’®

                // åªæœ‰åœ¨ä¸æ˜¯"æ­£åœ¨æš‚åœ"çŠ¶æ€æ—¶æ‰æ›´æ–°æŒ‰é’®
                if (!isPauseInProgress) {
                    pauseBtn.disabled = false;
                    pauseBtn.textContent = 'æš‚åœ';
                }
                stopBtn.disabled = false;
                stopBtn.textContent = 'åœæ­¢';

                // é‡ç½®æ¢å¤æŒ‰é’®æ–‡æœ¬
                resumeBtn.textContent = 'ç»§ç»­';
                progressContainer.style.display = 'block';
                detailedProgress.style.display = 'block';
                forceClearBtn.style.display = 'inline-flex';

                // ğŸš€ æ ¸å¿ƒä¼˜åŒ–ï¼šå¦‚æœåœ¨çˆ¬å–ä¸­ä½†è½®è¯¢é¢‘ç‡è¾ƒä½ï¼Œç«‹å³æå‡é¢‘ç‡
                if (!statusCheckInterval || statusCheckInterval._delay > 2000) {
                    if (statusCheckInterval) clearInterval(statusCheckInterval);
                    const itv = setInterval(checkCrawlStatus, 1000); // ç§’çº§åˆ·æ–°
                    itv._delay = 1000;
                    statusCheckInterval = itv;
                    console.log('âš¡ ä¾¦æµ‹åˆ°çˆ¬å–ä»»åŠ¡ï¼Œå·²æå‡çŠ¶æ€åˆ·æ–°é¢‘ç‡åˆ° 1s');
                }

                // æ›´æ–°è¿›åº¦
                if (status.progress) {
                    const progress = status.progress;

                    // ä¼˜å…ˆä½¿ç”¨é¡µé¢çº§åˆ«çš„è¿›åº¦ç™¾åˆ†æ¯”
                    let percentage = 0;
                    if (progress.progress_percent !== undefined) {
                        percentage = progress.progress_percent;
                    } else if (progress.sections_total > 0) {
                        percentage = (progress.sections_done / progress.sections_total) * 100;
                    }

                    document.getElementById('progress-fill').style.width = percentage + '%';

                    // æ˜¾ç¤ºé¡µé¢çº§åˆ«çš„è¿›åº¦
                    if (progress.processed_pages !== undefined && progress.estimated_total_pages) {
                        document.getElementById('progress-text').textContent =
                            `å·²çˆ¬å– ${progress.processed_pages}/${progress.estimated_total_pages} é¡µ`;
                    } else {
                        document.getElementById('progress-text').textContent =
                            `${progress.sections_done || 0}/${progress.sections_total || 0} ä¸ªæ¿å—`;
                    }

                    progressEl.textContent = `${Math.round(percentage)}%`;

                    // æ›´æ–°è¯¦ç»†è¿›åº¦
                    document.getElementById('current-section').textContent =
                        progress.current_section ? `æ­£åœ¨çˆ¬å–: ${progress.current_section}` : 'å‡†å¤‡ä¸­...';

                    // ã€ä¼˜åŒ–ã€‘é¡µç æ˜¾ç¤º - åŒºåˆ†å®é™…é¡µç å’Œä»»åŠ¡è¿›åº¦
                    let pageProgressText = '';
                    if (progress.current_page_actual && progress.max_pages_actual) {
                        // ä½¿ç”¨æ–°çš„é¡µç æ¦‚å¿µå­—æ®µï¼ˆèŒƒå›´çˆ¬å–æ¨¡å¼ï¼‰
                        const actualPageDisplay = `å½“å‰çˆ¬å–çš„æ˜¯ï¼šç¬¬ ${progress.current_page_actual} / ${progress.max_pages_actual} é¡µ`;
                        const taskProgressDisplay = `(æ¿å—ä»»åŠ¡è¿›åº¦: ç¬¬ ${progress.current_page_task} / ${progress.max_pages_task} é¡µ)`;
                        pageProgressText = `${actualPageDisplay} ${taskProgressDisplay}`;
                    } else if (progress.current_page && progress.max_pages) {
                        // å›é€€åˆ°æ—§çš„å­—æ®µï¼ˆæ™®é€šæ¨¡å¼ï¼‰
                        pageProgressText = `ç¬¬ ${progress.current_page} / ${progress.max_pages} é¡µ`;
                    }

                    document.getElementById('page-progress').textContent = pageProgressText;

                    document.getElementById('save-progress').textContent =
                        `å·²ä¿å­˜: ${progress.total_saved || 0} æ¡ï¼Œé‡å¤ä¸”è·³è¿‡: ${progress.total_skipped || 0} æ¡`;
                }
            }
            else {
                isCrawling = false; // æ›´æ–°å…¨å±€çŠ¶æ€
                crawlBtn.style.display = 'inline-flex';
                stopBtn.style.display = 'none';
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'none';
                forceClearBtn.style.display = 'none';
                progressContainer.style.display = 'none';
                detailedProgress.style.display = 'none';
                progressEl.textContent = '-';

                // é‡ç½®æ‰€æœ‰æŒ‰é’®æ–‡æœ¬ï¼Œç¡®ä¿ä¸‹æ¬¡ä½¿ç”¨æ—¶çŠ¶æ€æ­£ç¡®
                crawlBtn.textContent = 'å¼€å§‹çˆ¬å–';
                crawlBtn.disabled = false;
                stopBtn.textContent = 'åœæ­¢';
                stopBtn.disabled = false;
                pauseBtn.textContent = 'æš‚åœ';
                pauseBtn.disabled = false;
                resumeBtn.textContent = 'ç»§ç»­';
                resumeBtn.disabled = false;

                // çˆ¬è™«å®Œæˆåï¼Œæ¢å¤æ­£å¸¸æ£€æŸ¥é¢‘ç‡
                if (statusCheckInterval && statusCheckInterval._delay < 10000) {
                    clearInterval(statusCheckInterval);
                    const itv = setInterval(checkCrawlStatus, 10000); // 10ç§’ä¸€æ¬¡
                    itv._delay = 10000;
                    statusCheckInterval = itv;
                    console.log('ğŸ’¤ çˆ¬å–ä»»åŠ¡ç»“æŸï¼Œå·²é™ä½çŠ¶æ€åˆ·æ–°é¢‘ç‡');
                }

                // å¦‚æœåˆšå®Œæˆçˆ¬å–ï¼Œæ˜¾ç¤ºç»“æœ
                if (status.last_result) {
                    showCrawlResults(status.last_result);
                }
            }
        } catch (error) {
            console.error('æ£€æŸ¥çˆ¬è™«çŠ¶æ€å¤±è´¥', error);
        }
    }

    // æ˜¾ç¤ºçˆ¬å–ç»“æœ
    function toggleCrawlDetails() {
        const drawer = document.getElementById('crawl-details-drawer');
        const icon = document.querySelector('.details-toggle-icon');
        if (drawer) {
            drawer.classList.toggle('open');
            if (icon) {
                icon.classList.toggle('rotate');
            }
        }
    }

    // æ˜¾ç¤ºçˆ¬å–ç»“æœ
    function showCrawlResults(result) {
        const resultsCard = document.getElementById('crawl-results-card');
        const resultsContent = document.getElementById('crawl-results-content');
        const resultsTitle = document.getElementById('crawl-results-title');

        if (!result || !resultsCard || !resultsContent) return;

        const totalNew = result.total_saved || 0;
        const totalSkipped = result.total_skipped || 0;
        const totalTime = result.total_time || '0ç§’';
        const durationSeconds = result.duration_seconds || 0;
        const timestamp = result.timestamp || new Date().toISOString();

        // å…ƒæ•°æ®å’Œé«˜çº§ç»Ÿè®¡
        const metadata = result.metadata || {};
        const mode = metadata.mode || 'unknown';
        const concurrency = metadata.concurrency || 1;

        // è®¡ç®—æ•ˆç‡æŒ‡æ ‡
        const totalItems = totalNew + totalSkipped;
        const itemsPerMinute = durationSeconds > 0 ? ((totalItems / durationSeconds) * 60).toFixed(1) : 0;
        const secondsPerItem = totalItems > 0 ? (durationSeconds / totalItems).toFixed(2) : 0;

        // ç”Ÿæˆå…ƒæ•°æ®æ ‡ç­¾
        let metaBadges = '';
        if (mode === 'async') {
            metaBadges += `<span class="badge badge-purple" title="å¹¶å‘æ•°: ${concurrency}">âš¡ å¼‚æ­¥æ¨¡å¼ (å¹¶å‘ ${concurrency})</span>`;
        } else if (mode === 'thread') {
            metaBadges += `<span class="badge badge-blue">ğŸ§µ å¤šçº¿ç¨‹æ¨¡å¼</span>`;
        } else {
            metaBadges += `<span class="badge badge-gray">ğŸ”„ åŒæ­¥æ¨¡å¼</span>`;
        }

        // ä»£ç†çŠ¶æ€
        if (metadata.proxy_enabled) {
            metaBadges += `<span class="badge badge-yellow">ğŸ›¡ï¸ ä»£ç†å¼€å¯</span>`;
        }

        if (resultsTitle) {
            resultsTitle.innerHTML = `çˆ¬å–ä»»åŠ¡å®Œæˆ ${metaBadges}`;
        }

        const sections = result.sections || {};
        // é¡µé¢çº§åˆ«ç»Ÿè®¡
        const pageStats = result.page_statistics || {};
        const sectionPageBreakdown = result.section_page_breakdown || {};

        let sectionsHtml = '';
        // sections æ˜¯å¯¹è±¡ï¼Œéœ€è¦éå†é”®å€¼å¯¹
        Object.entries(sections).forEach(([sectionName, sectionData]) => {
            const saved = sectionData.saved || 0;
            const skipped = sectionData.skipped || 0;

            // åªæ˜¾ç¤ºæœ‰æ•°æ®çš„æ¿å—
            if (saved > 0 || skipped > 0) {
                // è·å–è¯¥æ¿å—çš„é¡µé¢ç»Ÿè®¡
                const sectionPages = sectionPageBreakdown[sectionName] || {};
                const successfulPages = sectionPages.successful_pages || [];
                const failedPages = sectionPages.failed_pages || [];
                const totalPages = sectionPages.total_pages || 0;

                let pageInfo = '';
                if (totalPages > 0) {
                    const successCount = successfulPages.length;
                    const failedCount = failedPages.length;

                    if (failedCount > 0) {
                        pageInfo = `<br><small style="color: var(--muted-foreground);">
                        é¡µé¢: ${successCount}æˆåŠŸ/${totalPages}æ€»è®¡ 
                        ${failedCount > 0 ? `(å¤±è´¥: ${failedPages.join(', ')})` : ''}
                    </small>`;
                    } else {
                        pageInfo = `<br><small style="color: var(--muted-foreground);">
                        é¡µé¢: ${successCount}/${totalPages}
                    </small>`;
                    }
                }

                sectionsHtml += `
                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                    <span>${sectionName}${pageInfo}</span>
                    <span style="color: var(--muted-foreground);">
                        æ–°å¢: <strong style="color: var(--emerald-500);">${saved}</strong>, 
                        è·³è¿‡: ${skipped}
                    </span>
                </div>
            `;
            }
        });

        // é¡µé¢çº§åˆ«æ‘˜è¦
        let pageStatsHtml = '';
        if (pageStats.total_attempted > 0) {
            const successRate = pageStats.success_rate || 0;
            const totalAttempted = pageStats.total_attempted || 0;
            const totalSuccessful = pageStats.total_successful || 0;
            const totalFailed = pageStats.total_failed || 0;

            let failedPagesDetail = '';
            if (totalFailed > 0 && pageStats.failed_pages_detail) {
                const failedPages = pageStats.failed_pages_detail;
                const failedBySection = {};

                failedPages.forEach(page => {
                    if (!failedBySection[page.section]) {
                        failedBySection[page.section] = [];
                    }
                    failedBySection[page.section].push(page.page);
                });

                const failedSummary = Object.entries(failedBySection)
                    .map(([section, pages]) => `${section}: ç¬¬${pages.join(', ')}é¡µ`)
                    .join('; ');

                failedPagesDetail = `<br><small style="color: var(--red-500);">å¤±è´¥é¡µé¢: ${failedSummary}</small>`;
            }

            pageStatsHtml = `
            <div style="margin: 1rem 0; padding: 1rem; background: var(--muted); border-radius: var(--border-radius);">
                <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">é¡µé¢ç»Ÿè®¡</div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground);">
                    æ€»è®¡: ${totalAttempted}é¡µ | æˆåŠŸ: ${totalSuccessful}é¡µ | å¤±è´¥: ${totalFailed}é¡µ | æˆåŠŸç‡: ${successRate}%
                    ${failedPagesDetail}
                </div>
            </div>
        `;
        }

        // é‡è¯•ç»Ÿè®¡
        let retryStatsHtml = '';
        if (pageStats.retry_summary && pageStats.retry_summary.attempted > 0) {
            const retry = pageStats.retry_summary;
            retryStatsHtml = `
            <div style="margin: 1rem 0; padding: 1rem; background: var(--muted); border-radius: var(--border-radius);">
                <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">é‡è¯•ç»Ÿè®¡</div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground);">
                    é‡è¯•: ${retry.attempted}é¡µ | æˆåŠŸ: ${retry.successful}é¡µ | å¤±è´¥: ${retry.failed}é¡µ
                    ${retry.saved > 0 ? `| æ–°å¢: ${retry.saved}` : ''}${retry.skipped > 0 ? `| è·³è¿‡: ${retry.skipped}` : ''}
                </div>
            </div>
        `;
        }

        resultsContent.innerHTML = `
        <div class="crawl-results-stats">
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--emerald-500);">${totalNew}</div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground);">æ–°å¢èµ„æº</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--muted-foreground);">${totalSkipped}</div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground);">è·³è¿‡é‡å¤</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--blue-500);">${totalTime}</div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground);">æ€»è€—æ—¶</div>
            </div>
        </div>
        
        <!-- å¼•æ“å…ƒæ•°æ® & æ•ˆèƒ½ç»Ÿè®¡ -->
        <div style="margin: 1rem 0; padding: 1rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--border-radius); display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground); margin-bottom: 0.25rem;">å¼•æ“é…ç½®</div>
                <div style="font-size: 0.875rem; font-weight: 500;">
                    ${metadata.mode === 'async' ? 'âš¡ å¼‚æ­¥æ¨¡å¼' : (metadata.mode === 'thread' ? 'ğŸ”€ å¤šçº¿ç¨‹' : 'â¡ï¸ ä¸²è¡Œ')} 
                    (${metadata.concurrency || '-'})
                </div>
                <div style="font-size: 0.7rem; color: var(--muted-foreground);">
                    å»¶è¿Ÿ: ${metadata.delay_min}-${metadata.delay_max}s 
                    | ä»£ç†: ${metadata.proxy_active ? 'å¯ç”¨' : 'æœªç”¨'}
                </div>
            </div>
            <div style="text-align: right; border-left: 1px solid var(--border); padding-left: 1rem;">
                <div style="font-size: 0.75rem; color: var(--muted-foreground); margin-bottom: 0.25rem;">çˆ¬å–æ•ˆèƒ½</div>
                <div style="font-size: 0.875rem; font-weight: 500; color: var(--emerald-500);">
                    ${itemsPerMinute} <small>é¡¹/åˆ†</small>
                </div>
                <div style="font-size: 0.7rem; color: var(--muted-foreground);">
                    å¹³å‡æ¯é¡¹: ${secondsPerItem}s
                </div>
            </div>
        </div>

        ${pageStatsHtml}
        ${retryStatsHtml}
        ${sectionsHtml ? `
            <div style="margin-top: 1rem;">
                <button onclick="toggleCrawlDetails()" class="btn btn-secondary btn-sm" style="width: 100%; justify-content: space-between; display: flex; align-items: center;">
                    <span>æŸ¥çœ‹æ¿å—è¯¦æƒ…</span>
                    <span class="details-toggle-icon">â–¼</span>
                </button>
                <div id="crawl-details-drawer" class="crawl-details-drawer">
                    ${sectionsHtml}
                </div>
            </div>
        ` : ''}
        <div style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 1rem;">
            å®Œæˆæ—¶é—´: ${new Date(timestamp).toLocaleString()}
        </div>
    `;

        resultsCard.style.display = 'block';
    }

    // åŠ è½½æœ€è¿‘çš„çˆ¬å–ç»“æœ
    async function loadRecentCrawlResults() {
        try {
            const response = await fetch('/api/crawl/status');
            const status = await response.json();

            if (status.last_result) {
                showCrawlResults(status.last_result);
            }
        } catch (error) {
            console.warn('åŠ è½½æœ€è¿‘çˆ¬å–ç»“æœå¤±è´¥:', error);
        }
    }

    // åˆ·æ–°çˆ¬å–ç»“æœ
    async function refreshCrawlResults() {
        try {
            const response = await fetch('/api/crawl/status');
            const status = await response.json();

            if (status.last_result) {
                showCrawlResults(status.last_result);
                showToast('ç»“æœå·²åˆ·æ–°', 'success');
            } else {
                showToast('æš‚æ— çˆ¬å–ç»“æœ', 'info');
            }
        } catch (error) {
            console.error('åˆ·æ–°çˆ¬å–ç»“æœå¤±è´¥:', error);
            showToast('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ¸…é™¤çˆ¬å–ç»“æœ
    function clearCrawlResults() {
        const resultsContent = document.getElementById('crawl-results-content');
        if (resultsContent) {
            resultsContent.innerHTML = `
            <div style="text-align: center; color: var(--muted-foreground); padding: 2rem;">
                æš‚æ— çˆ¬å–è®°å½•
            </div>
        `;
        }
    }

    // å¼€å§‹çˆ¬å–
    async function startCrawl() {
        if (selectedForums.length === 0) {
            showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®ºå›', 'warning');
            return;
        }

        try {
            const dateMode = document.getElementById('dateMode').value;
            const pageMode = document.getElementById('pageMode').value;
            const maxPages = parseInt(document.getElementById('maxPages').value);

            const config = {
                fids: selectedForums,
                date_mode: dateMode,
                max_pages: maxPages,
                page_mode: pageMode
            };

            // å¦‚æœæ˜¯èŒƒå›´æ¨¡å¼ï¼Œæ·»åŠ  page_rangeå‚æ•°
            if (pageMode === 'range') {
                const startPage = document.getElementById('startPage').value;
                const endPage = document.getElementById('endPage').value;
                if (!startPage || !endPage) {
                    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„èµ·æ­¢é¡µç ', 'error');
                    return;
                }
                config.page_range = [parseInt(startPage), parseInt(endPage)];
                // è‡ªåŠ¨è®¡ç®—é¡µæ•°ä¾›å‚è€ƒ
                config.max_pages = parseInt(endPage) - parseInt(startPage) + 1;
            }

            // ç«‹å³æ˜¾ç¤ºçˆ¬è™«çŠ¶æ€UI
            const crawlBtn = document.getElementById('crawlBtn');
            const stopBtn = document.getElementById('stopBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const progressContainer = document.getElementById('progress-container');
            const detailedProgress = document.getElementById('detailed-progress');

            crawlBtn.style.display = 'none';
            stopBtn.style.display = 'inline-flex';
            pauseBtn.style.display = 'inline-flex';
            resumeBtn.style.display = 'none';
            pauseBtn.disabled = false;
            stopBtn.disabled = false;
            progressContainer.style.display = 'block';
            detailedProgress.style.display = 'block';

            // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-text').textContent = 'å‡†å¤‡ä¸­...';
            document.getElementById('current-section').textContent = 'æ­£åœ¨å¯åŠ¨çˆ¬è™«...';
            document.getElementById('page-progress').textContent = '';
            document.getElementById('save-progress').textContent = 'å·²ä¿å­˜: 0 æ¡ï¼Œè·³è¿‡: 0 æ¡';

            const response = await fetch('/api/crawl/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            });

            if (response.ok) {
                showToast('çˆ¬è™«ä»»åŠ¡å·²å¯åŠ¨', 'success');
                // ç«‹å³å¼€å§‹çŠ¶æ€æ£€æŸ¥ï¼Œå¹¶å¢åŠ æ£€æŸ¥é¢‘ç‡
                checkCrawlStatus();
                // å¯åŠ¨ç§’çº§å®æ—¶ç›‘æ§
                if (statusCheckInterval) clearInterval(statusCheckInterval);
                const itv = setInterval(checkCrawlStatus, 1000);
                itv._delay = 1000;
                statusCheckInterval = itv;
            } else {
                const errorData = await response.json();
                showToast('å¯åŠ¨çˆ¬è™«å¤±è´¥: ' + (errorData.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                crawlBtn.style.display = 'inline-flex';
                stopBtn.style.display = 'none';
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'none';
                progressContainer.style.display = 'none';
                detailedProgress.style.display = 'none';
            }
        } catch (error) {
            console.error('å¯åŠ¨çˆ¬è™«å¤±è´¥', error);
            showToast('å¯åŠ¨çˆ¬è™«å¤±è´¥: ' + error.message, 'error');
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const crawlBtn = document.getElementById('crawlBtn');
            const stopBtn = document.getElementById('stopBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const progressContainer = document.getElementById('progress-container');
            const detailedProgress = document.getElementById('detailed-progress');

            crawlBtn.style.display = 'inline-flex';
            stopBtn.style.display = 'none';
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            progressContainer.style.display = 'none';
            detailedProgress.style.display = 'none';
        }
    }

    // æŒ‰é’®çŠ¶æ€ç®¡ç†å™¨
    const ButtonStateManager = {
        buttons: {
            crawl: null,
            stop: null,
            pause: null,
            resume: null,
            forceClear: null
        },

        init() {
            this.buttons.crawl = document.getElementById('crawlBtn');
            this.buttons.stop = document.getElementById('stopBtn');
            this.buttons.pause = document.getElementById('pauseBtn');
            this.buttons.resume = document.getElementById('resumeBtn');
            this.buttons.forceClear = document.getElementById('forceClearBtn');
        },

        // é‡ç½®æ‰€æœ‰æŒ‰é’®åˆ°åˆå§‹çŠ¶æ€
        resetToIdle() {
            this.buttons.crawl.style.display = 'inline-flex';
            this.buttons.crawl.disabled = false;
            this.buttons.crawl.textContent = 'å¼€å§‹çˆ¬å–';

            this.buttons.stop.style.display = 'none';
            this.buttons.stop.disabled = false;
            this.buttons.stop.textContent = 'åœæ­¢';

            this.buttons.pause.style.display = 'none';
            this.buttons.pause.disabled = false;
            this.buttons.pause.textContent = 'æš‚åœ';

            this.buttons.resume.style.display = 'none';
            this.buttons.resume.disabled = false;
            this.buttons.resume.textContent = 'ç»§ç»­';

            this.buttons.forceClear.style.display = 'none';
        },

        // è®¾ç½®ä¸ºç©ºé—²çŠ¶æ€ï¼ˆåˆ«åï¼‰
        setIdle() {
            this.resetToIdle();
        },

        // è®¾ç½®ä¸ºè¿è¡ŒçŠ¶æ€
        setRunning() {
            this.buttons.crawl.style.display = 'none';
            this.buttons.stop.style.display = 'inline-flex';
            this.buttons.stop.disabled = false;
            this.buttons.pause.style.display = 'inline-flex';
            this.buttons.pause.disabled = false;
            this.buttons.resume.style.display = 'none';
            this.buttons.forceClear.style.display = 'inline-flex';
        },

        // è®¾ç½®ä¸ºæš‚åœçŠ¶æ€
        setPaused() {
            this.buttons.crawl.style.display = 'none';
            this.buttons.stop.style.display = 'inline-flex';
            this.buttons.stop.disabled = false;
            this.buttons.pause.style.display = 'none';
            this.buttons.resume.style.display = 'inline-flex';
            this.buttons.resume.disabled = false;
            this.buttons.forceClear.style.display = 'inline-flex';
        },

        // è®¾ç½®ä¸ºåœæ­¢ä¸­çŠ¶æ€
        setStopping() {
            this.buttons.stop.textContent = 'æ­£åœ¨åœæ­¢...';
            this.buttons.stop.disabled = true;
            this.buttons.pause.disabled = true;
            this.buttons.resume.disabled = true;
            this.buttons.forceClear.style.display = 'inline-flex';
        },

        // è®¾ç½®ä¸ºæš‚åœä¸­çŠ¶æ€
        setPausing() {
            this.buttons.pause.textContent = 'æ­£åœ¨æš‚åœ...';
            this.buttons.pause.disabled = true;
            this.buttons.stop.disabled = false;
            this.buttons.forceClear.style.display = 'inline-flex';
        },

        // è®¾ç½®ä¸ºæ¢å¤ä¸­çŠ¶æ€
        setResuming() {
            this.buttons.resume.textContent = 'æ­£åœ¨æ¢å¤...';
            this.buttons.resume.disabled = true;
            this.buttons.stop.disabled = false;
            this.buttons.forceClear.style.display = 'inline-flex';
        },

        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        showError(buttonType, errorMessage) {
            const btn = this.buttons[buttonType];
            if (!btn) return;

            const originalText = btn.textContent;
            btn.textContent = 'æ“ä½œå¤±è´¥';
            btn.classList.add('btn-destructive');

            // 3ç§’åæ¢å¤
            setTimeout(() => {
                btn.classList.remove('btn-destructive');
                this.resetButtonText(buttonType);
            }, 3000);

            showToast(errorMessage, 'error');
        },

        // é‡ç½®æŒ‰é’®æ–‡æœ¬
        resetButtonText(buttonType) {
            const defaults = {
                crawl: 'å¼€å§‹çˆ¬å–',
                stop: 'åœæ­¢',
                pause: 'æš‚åœ',
                resume: 'ç»§ç»­'
            };

            const btn = this.buttons[buttonType];
            if (btn && defaults[buttonType]) {
                btn.textContent = defaults[buttonType];
                btn.disabled = false;
            }
        }
    };

    function isApiSuccess(result) {
        return !!(result && (result.success === true || result.code === 0 || result.status === 'success'));
    }

    // åœæ­¢çˆ¬å–
    async function stopCrawl() {
        // ã€ä¿®å¤ã€‘ä½¿ç”¨å…¨å±€é€šçŸ¥è€Œä¸æ˜¯æµè§ˆå™¨å¼¹çª—
        showConfirmToast('ç¡®å®šè¦åœæ­¢æ­£åœ¨è¿›è¡Œçš„çˆ¬å–ä»»åŠ¡å—ï¼Ÿ',
            async () => {
                try {
                    ButtonStateManager.setStopping();

                    const response = await fetch('/api/crawl/stop', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force: true })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (isApiSuccess(result)) {
                        showToast('å·²å‘é€åœæ­¢å‘½ä»¤ï¼Œè¯·ç­‰å¾…ä»»åŠ¡å®Œæˆ...', 'success');
                        // ä¸ç«‹å³é‡ç½®æŒ‰é’®çŠ¶æ€ï¼Œç­‰å¾…è½®è¯¢æ£€æµ‹åˆ°åœæ­¢çŠ¶æ€åå†é‡ç½®
                    } else {
                        ButtonStateManager.showError('stop', 'åœæ­¢å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    console.error('åœæ­¢çˆ¬å–å¤±è´¥:', error);
                    ButtonStateManager.showError('stop', 'åœæ­¢è¯·æ±‚å¤±è´¥: ' + error.message);
                }
            },
            () => {
                showToast('å·²å–æ¶ˆåœæ­¢æ“ä½œ', 'info');
                console.log('ç”¨æˆ·å–æ¶ˆåœæ­¢');
            }
        );
    }

    // å¼ºåˆ¶æ¸…é™¤ä»»åŠ¡
    async function forceClearTask() {
        // ä½¿ç”¨ç³»ç»Ÿç»Ÿä¸€çš„ç¡®è®¤å¼¹çª—ï¼ˆéæµè§ˆå™¨åŸç”Ÿ confirmï¼‰
        showConfirmToast('ç¡®å®šè¦å¼ºåˆ¶æ¸…é™¤å½“å‰ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰çŠ¶æ€å’Œä¿¡å·ï¼Œè¯·ä»…åœ¨ä»»åŠ¡å¡ä½æ—¶ä½¿ç”¨ã€‚',
            async () => {
                // ç¡®è®¤å›è°ƒ
                try {
                    const response = await fetch('/api/crawl/force-clear', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast('å·²å¼ºåˆ¶æ¸…é™¤ä»»åŠ¡', 'success');
                        // é‡ç½® UI çŠ¶æ€
                        ButtonStateManager.setIdle();

                        // é‡ç½®è¿›åº¦æ˜¾ç¤º
                        document.getElementById('progress-fill').style.width = '0%';
                        document.getElementById('progress-text').textContent = '0%';
                        document.getElementById('current-section').textContent = 'ç©ºé—²';
                        document.getElementById('page-progress').textContent = '';

                        // å¼ºåˆ¶åˆ·æ–°çŠ¶æ€
                        checkCrawlStatus();
                    } else {
                        showToast('æ¸…é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                } catch (error) {
                    console.error('å¼ºåˆ¶æ¸…é™¤å¤±è´¥:', error);
                    showToast('è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            },
            () => {
                // å–æ¶ˆå›è°ƒ
                showToast('å·²å–æ¶ˆå¼ºåˆ¶æ¸…é™¤', 'info');
            }
        );
    }

    async function pauseCrawl() {
        try {
            // ã€ä¿®å¤ã€‘é˜²æŠ–ï¼šå¦‚æœæŒ‰é’®å·²ç»åœ¨å¤„ç†ä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»
            const pauseBtn = document.getElementById('pauseBtn');
            if (pauseBtn.disabled || pauseBtn.textContent.includes('æ­£åœ¨')) {
                console.log('âš ï¸ æš‚åœæ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
                return;
            }

            ButtonStateManager.setPausing();

            const response = await fetch('/api/crawl/pause', { method: 'POST' });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (isApiSuccess(result)) {
                showToast('å·²å‘é€æš‚åœå‘½ä»¤...', 'success');
                // ä¸ç«‹å³æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼Œç­‰å¾…è½®è¯¢æ£€æµ‹åˆ°æš‚åœçŠ¶æ€åå†æ›´æ–°
            } else {
                ButtonStateManager.showError('pause', 'æš‚åœå¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('æš‚åœçˆ¬å–å¤±è´¥:', error);
            ButtonStateManager.showError('pause', 'æš‚åœè¯·æ±‚å¤±è´¥: ' + error.message);
        }
    }

    async function resumeCrawl() {
        try {
            // ã€ä¿®å¤ã€‘é˜²æŠ–ï¼šå¦‚æœæŒ‰é’®å·²ç»åœ¨å¤„ç†ä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»
            const resumeBtn = document.getElementById('resumeBtn');
            if (resumeBtn.disabled || resumeBtn.textContent.includes('æ­£åœ¨')) {
                console.log('âš ï¸ æ¢å¤æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
                return;
            }

            ButtonStateManager.setResuming();

            const response = await fetch('/api/crawl/resume', { method: 'POST' });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (isApiSuccess(result)) {
                showToast('å·²å‘é€æ¢å¤å‘½ä»¤...', 'success');
                // ä¸ç«‹å³æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼Œç­‰å¾…è½®è¯¢æ£€æµ‹åˆ°æ¢å¤çŠ¶æ€åå†æ›´æ–°
            } else {
                ButtonStateManager.showError('resume', 'æ¢å¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('æ¢å¤çˆ¬å–å¤±è´¥:', error);
            ButtonStateManager.showError('resume', 'æ¢å¤è¯·æ±‚å¤±è´¥: ' + error.message);
        }
    }

    // ==================== å¤±è´¥TIDç®¡ç†åŠŸèƒ½ ====================

    // åŠ è½½å¤±è´¥TIDç»Ÿè®¡
    async function loadFailedTidsStats() {
        try {
            const response = await fetch('/api/failed-tids/summary');
            const result = await response.json();

            if (result.status === 'success' && result.data) {
                const stats = result.data;

                // ä¿®å¤ï¼šåç«¯è¿”å›çš„æ˜¯ pending, success, abandoned ç›´æ¥åœ¨ data ä¸‹
                document.getElementById('pending-count').textContent =
                    (stats.pending || 0) + (stats.retrying || 0);
                document.getElementById('success-count').textContent = stats.success || 0;
                document.getElementById('abandoned-count').textContent = stats.abandoned || 0;
            } else {
                document.getElementById('pending-count').textContent = '0';
                document.getElementById('success-count').textContent = '0';
                document.getElementById('abandoned-count').textContent = '0';
            }
        } catch (error) {
            console.error('åŠ è½½å¤±è´¥TIDç»Ÿè®¡å¤±è´¥:', error);
            showToast('åŠ è½½å¤±è´¥TIDç»Ÿè®¡å¤±è´¥', 'error');
        }
    }

    // åˆ‡æ¢é‡è¯•æ¨¡å¼é€‰é¡¹æ˜¾ç¤º
    function toggleRetryModeOptions() {
        const mode = document.querySelector('input[name="retryMode"]:checked').value;
        const maxRoundsContainer = document.getElementById('maxRoundsContainer');
        const modeTip = document.getElementById('modeTip');
        const limit = parseInt(document.getElementById('retryLimit').value) || 0;
        const maxRounds = parseInt(document.getElementById('maxRounds').value) || 0;

        if (mode === 'continuous') {
            maxRoundsContainer.style.display = 'block';
            const totalMax = limit * maxRounds;
            modeTip.className = 'mode-tip-box success';
            modeTip.innerHTML = `
                <span class="mode-tip-emoji">ğŸ”„</span>
                <div class="mode-tip-text">
                    <strong>å¾ªç¯æ¨¡å¼</strong>ï¼šæ¯è½®å¤„ç† <strong>${limit}</strong> ä¸ªTIDï¼Œ
                    æœ€å¤š <strong>${maxRounds}</strong> è½®ï¼Œ
                    é¢„è®¡æœ€å¤šå¤„ç† <strong>${totalMax}</strong> ä¸ªTID
                </div>
            `;
        } else {
            maxRoundsContainer.style.display = 'none';
            modeTip.className = 'mode-tip-box info';
            modeTip.innerHTML = `
                <span class="mode-tip-emoji">ğŸ’¡</span>
                <div class="mode-tip-text">
                    <strong>å•è½®æ¨¡å¼</strong>ï¼šå¤„ç† <strong>${limit}</strong> ä¸ªTIDååœæ­¢
                </div>
            `;
        }
    }

    // é‡è¯•å¤±è´¥TID
    async function retryFailedTids() {
        const mode = document.querySelector('input[name="retryMode"]:checked').value;
        const limit = parseInt(document.getElementById('retryLimit').value);
        const maxRounds = parseInt(document.getElementById('maxRounds').value);
        const isContinuous = mode === 'continuous';

        const modeDesc = isContinuous
            ? `å¾ªç¯æ¨¡å¼ï¼ˆæ¯è½®${limit}ä¸ªï¼Œæœ€å¤š${maxRounds}è½®ï¼‰`
            : `å•è½®æ¨¡å¼ï¼ˆå¤„ç†${limit}ä¸ªï¼‰`;

        showConfirmToast(`ç¡®å®šè¦ä½¿ç”¨ ${modeDesc} é‡è¯•å¤±è´¥çš„TIDå—ï¼Ÿ`,
            async () => {
                try {
                    const response = await fetch('/api/failed-tids/retry', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            limit: limit,
                            batch_size: 10,
                            continuous: isContinuous,
                            max_rounds: maxRounds
                        })
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        showToast(result.message, 'success');
                        // å»¶è¿Ÿåˆ·æ–°ç»Ÿè®¡
                        setTimeout(loadFailedTidsStats, 5000);
                    } else {
                        showToast('å¯åŠ¨é‡è¯•ä»»åŠ¡å¤±è´¥: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('é‡è¯•å¤±è´¥TIDå¤±è´¥:', error);
                    showToast('é‡è¯•å¤±è´¥TIDå¤±è´¥: ' + error.message, 'error');
                }
            },
            () => {
                showToast('å·²å–æ¶ˆæ“ä½œ', 'info');
                console.log('ç”¨æˆ·å–æ¶ˆé‡è¯•');
            }
        );
    }

    // æ˜¾ç¤ºå¤±è´¥TIDåˆ—è¡¨
    async function showFailedTidsList(status = 'pending') {
        const listDiv = document.getElementById('failed-tids-list-wrapper');
        const contentDiv = document.getElementById('failed-tids-content');

        const isCurrentlyExpanded = listDiv.classList.contains('expanded');

        // å¦‚æœå·²ç»å±•å¼€å¹¶ä¸”ç‚¹å‡»çš„æ˜¯ç›¸åŒçš„çŠ¶æ€ï¼Œåˆ™æ”¶èµ·
        if (isCurrentlyExpanded && window.currentFailedTidsStatus === status) {
            listDiv.classList.remove('expanded');
            return;
        }

        // æ˜¾å¼æ˜¾ç¤ºåˆ—è¡¨æˆ–åˆ‡æ¢çŠ¶æ€
        listDiv.classList.add('expanded');
        window.currentFailedTidsStatus = status;
        contentDiv.innerHTML = 'æ­£åœ¨åŠ è½½...';

        try {
            // æ ¹æ®çŠ¶æ€æ„å»ºAPI URL
            let apiUrl = '/api/failed-tids/list?limit=100';
            if (status === 'abandoned') {
                // éœ€è¦ä¿®æ”¹APIä»¥æ”¯æŒabandonedçŠ¶æ€æŸ¥è¯¢
                apiUrl = '/api/failed-tids/list?status=abandoned&limit=100';
            }

            const response = await fetch(apiUrl);
            const result = await response.json();

            if (result.status === 'success' && result.data) {
                const failedTids = result.data;

                if (failedTids.length === 0) {
                    const emptyMessage = status === 'abandoned' ? 'æš‚æ— å·²æ”¾å¼ƒçš„TID' : 'æš‚æ— å¾…é‡è¯•çš„TID';
                    contentDiv.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--muted-foreground);">${emptyMessage}</div>`;
                } else {
                    let html = '';
                    const listTitle = status === 'abandoned' ? 'å·²æ”¾å¼ƒTIDåˆ—è¡¨' : 'å¾…é‡è¯•TIDåˆ—è¡¨';

                    // æ›´æ–°åˆ—è¡¨æ ‡é¢˜
                    document.querySelector('.failed-tid-list-title').textContent = listTitle;

                    failedTids.forEach((item, index) => {
                        // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ“ä½œæŒ‰é’®
                        let actionButtons = '';
                        if (status === 'abandoned') {
                            actionButtons = `
                                <button onclick="restoreFailedTid(${item.tid})" class="btn btn-xs btn-success" title="é‡æ–°åŠ å…¥é‡è¯•åˆ—è¡¨">
                                    é‡æ–°é‡è¯•
                                </button>
                            `;
                        } else {
                            actionButtons = `
                                <button onclick="abandonFailedTid(${item.tid})" class="btn btn-xs btn-destructive" title="æ”¾å¼ƒæ­¤TID">
                                    æ”¾å¼ƒ
                                </button>
                            `;
                        }

                        html += `
                            <div class="failed-tid-item">
                                <div class="failed-tid-info">
                                    <div class="failed-tid-id">TID: ${item.tid}</div>
                                    <div class="failed-tid-meta">
                                        <div class="failed-tid-section">
                                            ${item.section || 'æœªçŸ¥æ¿å—'}
                                        </div>
                                        <div class="failed-tid-retry-count">
                                            é‡è¯• ${item.retry_count} æ¬¡
                                        </div>
                                    </div>
                                    <div class="failed-tid-reason">
                                        ${item.failure_reason || 'æœªçŸ¥åŸå› '}
                                    </div>
                                </div>
                                <div class="failed-tid-actions">
                                    ${actionButtons}
                                </div>
                            </div>
                        `;
                    });

                    contentDiv.innerHTML = html;
                }
            } else {
                contentDiv.innerHTML = '<div style="color: var(--destructive);">åŠ è½½å¤±è´¥TIDåˆ—è¡¨å¤±è´¥</div>';
            }
        } catch (error) {
            console.error('åŠ è½½å¤±è´¥TIDåˆ—è¡¨å¤±è´¥:', error);
            contentDiv.innerHTML = '<div style="color: var(--destructive);">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
        }
    }

    // æ¸…ç†å¤±è´¥TIDè®°å½•
    async function cleanupFailedTids() {
        const cleanupAction = async (data) => {
            try {
                const response = await fetch('/api/failed-tids/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showToast(result.message, 'success');
                    loadFailedTidsStats();
                    // å¦‚æœåˆ—è¡¨æ­£å¼€ç€ï¼Œåˆ·æ–°å®ƒ
                    const wrapper = document.getElementById('failed-tids-list-wrapper');
                    if (wrapper.style.maxHeight && wrapper.style.maxHeight !== '0px') {
                        showFailedTidsList(window.currentFailedTidsStatus || 'pending');
                    }
                } else {
                    showToast('æ¸…ç†å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('æ¸…ç†å¤±è´¥TIDè®°å½•å¤±è´¥:', error);
                showToast('æ¸…ç†å¤±è´¥: ' + error.message, 'error');
            }
        };

        // å¼¹å‡ºæ›´è¯¦ç»†çš„æ¸…ç†é€‰é¡¹
        const choice = await showChoiceToast('è¯·é€‰æ‹©æ¸…ç†èŒƒå›´', [
            { text: 'æ¸…ç† 30 å¤©å‰', value: '30days', color: 'btn-primary' },
            { text: 'æ¸…ç† "è§£æå¤±è´¥"', value: 'keyword', color: 'btn-purple' },
            { text: 'æ¸…ç©ºå…¨éƒ¨', value: 'all', color: 'btn-destructive' }
        ]);

        if (choice === '30days') {
            cleanupAction({ days: 30 });
        } else if (choice === 'keyword') {
            cleanupAction({ keyword: 'è§£æå¤±è´¥' });
        } else if (choice === 'all') {
            showConfirmToast('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰çš„å¤±è´¥è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
                () => cleanupAction({ all: true }),
                () => console.log('ç”¨æˆ·å–æ¶ˆæ¸…ç©ºå…¨éƒ¨')
            );
        }
    }

    // æ”¾å¼ƒå¤±è´¥TID
    async function abandonFailedTid(tid) {
        showConfirmToast(`ç¡®å®šè¦æ”¾å¼ƒ TID ${tid} å—ï¼Ÿ`,
            async () => {
                try {
                    const response = await fetch('/api/failed-tids/abandon', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ tid })
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        showToast(result.message, 'success');
                        // åˆ·æ–°åˆ—è¡¨å’Œç»Ÿè®¡
                        loadFailedTidsStats();
                        showFailedTidsList('pending');
                    } else {
                        showToast('æ”¾å¼ƒå¤±è´¥: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('æ”¾å¼ƒå¤±è´¥TIDå¤±è´¥:', error);
                    showToast('æ”¾å¼ƒå¤±è´¥: ' + error.message, 'error');
                }
            },
            () => {
                showToast('å·²å–æ¶ˆæ“ä½œ', 'info');
                console.log('ç”¨æˆ·å–æ¶ˆæ”¾å¼ƒ');
            }
        );
    }

    // æ¢å¤å¤±è´¥TIDåˆ°é‡è¯•åˆ—è¡¨
    async function restoreFailedTid(tid) {
        showConfirmToast(`ç¡®å®šè¦å°† TID ${tid} é‡æ–°åŠ å…¥é‡è¯•åˆ—è¡¨å—ï¼Ÿ`,
            async () => {
                try {
                    const response = await fetch('/api/failed-tids/restore', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ tid })
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        showToast(result.message, 'success');
                        // åˆ·æ–°åˆ—è¡¨å’Œç»Ÿè®¡
                        loadFailedTidsStats();
                        showFailedTidsList('abandoned');
                    } else {
                        showToast('æ¢å¤å¤±è´¥: ' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('æ¢å¤å¤±è´¥TIDå¤±è´¥:', error);
                    showToast('æ¢å¤å¤±è´¥: ' + error.message, 'error');
                }
            },
            () => {
                showToast('å·²å–æ¶ˆæ“ä½œ', 'info');
                console.log('ç”¨æˆ·å–æ¶ˆæ¢å¤');
            }
        );
    }
</script>
{% endblock %}