{% extends "base.html" %}

{% block title %}日志 - SHT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/logs.css') }}">
{% endblock %}

{% block content %}
<h1 class="page-title">日志</h1>

<div class="log-card">
    <div class="log-card-header">
        <div class="toolbar">
            <div class="search-wrapper">
                <input id="log-query" type="text" placeholder="搜索日志内容...">
                <button class="log-filter-btn" type="button" title="筛选日志" onclick="filterLogDisplay()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
            </div>

            <!-- 日志级别过滤器 -->
            <div class="log-level-filter">
                <label title="显示DEBUG级别日志">
                    <input type="checkbox" id="filter-debug" checked> DEBUG
                </label>
                <label title="显示INFO级别日志">
                    <input type="checkbox" id="filter-info" checked> INFO
                </label>
                <label title="显示WARNING级别日志">
                    <input type="checkbox" id="filter-warning" checked> WARN
                </label>
                <label title="显示ERROR级别日志">
                    <input type="checkbox" id="filter-error" checked> ERROR
                </label>
            </div>

            <div class="btn-group log-actions">
                <button class="btn btn-pink" title="复制当前页面显示的过滤后日志" onclick="copySessionLogs()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
                        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
                    </svg>
                    <span class="btn-text">复制日志</span>
                </button>

                <button class="btn btn-success" title="导出完整日志文件" onclick="exportLogs()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" x2="12" y1="15" y2="3"></line>
                    </svg>
                    <span class="btn-text">导出</span>
                </button>

                <button class="btn btn-destructive" title="清除日志缓存" onclick="clearLogs()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        <line x1="10" x2="10" y1="11" y2="17"></line>
                        <line x1="14" x2="14" y1="11" y2="17"></line>
                    </svg>
                    <span class="btn-text">清除</span>
                </button>

                <button class="btn btn-primary" title="刷新日志" onclick="loadLogs()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12a9 9 0 1 1-3.6-7.2"></path>
                        <polyline points="21 3 21 9 15 9"></polyline>
                    </svg>
                    <span class="btn-text">刷新</span>
                </button>
            </div>
        </div>
    </div>

    <div class="log-content">
        <div id="logStats" class="log-stats">
            正在加载日志统计信息...
        </div>
        <pre id="logDisplay" class="logs-display">正在加载日志...</pre>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    // 日志页面特定的JavaScript
    document.addEventListener('DOMContentLoaded', function () {
        // 加载数据
        loadLogs();

        // 添加日志级别过滤器事件监听
        const filterCheckboxes = ['filter-debug', 'filter-info', 'filter-warning', 'filter-error'];
        filterCheckboxes.forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.addEventListener('change', filterLogDisplay);
            }
        });

        // 关键词筛选输入
        const queryInput = document.getElementById('log-query');
        if (queryInput) {
            let queryTimer;
            queryInput.addEventListener('input', () => {
                clearTimeout(queryTimer);
                queryTimer = setTimeout(filterLogDisplay, 200);
            });
            queryInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    filterLogDisplay();
                }
            });
        }

        // 检查是否有CRITICAL过滤器
        const criticalFilter = document.getElementById('filter-critical');
        if (criticalFilter) {
            criticalFilter.addEventListener('change', filterLogDisplay);
        }

        // 添加手动刷新按钮事件
        const refreshStatusBtn = document.getElementById('refreshStatusBtn');
        if (refreshStatusBtn) {
            refreshStatusBtn.addEventListener('click', function () {
                loadLogs();

                // 按钮动画
                this.style.transform = 'rotate(360deg)';
                this.style.transition = 'transform 0.6s ease';
                setTimeout(() => {
                    this.style.transform = '';
                }, 600);
            });
        }
    });

    // 加载日志
    async function loadLogs() {
        try {
            const response = await fetch('/api/logs/recent?limit=10000');
            const data = await response.json();

            const logDisplay = document.getElementById('logDisplay');
            const logStats = document.getElementById('logStats');

            if (data.lines && Array.isArray(data.lines)) {
                const logsText = data.lines.join('\n');
                logDisplay.innerHTML = formatLogContent(logsText);

                // 应用当前筛选
                filterLogDisplay();

                // 更新统计信息
                const lines = data.lines.length;
                logStats.textContent = `显示最近 ${lines} 行日志 | 最后更新: ${new Date().toLocaleTimeString()}`;

                // 自动滚动到底部
                logDisplay.scrollTop = logDisplay.scrollHeight;
            } else if (data.logs) {
                // 兼容其他格式
                logDisplay.innerHTML = formatLogContent(data.logs);
                filterLogDisplay();
                const lines = data.logs.split('\n').length;
                logStats.textContent = `显示最近 ${lines} 行日志 | 最后更新: ${new Date().toLocaleTimeString()}`;
                logDisplay.scrollTop = logDisplay.scrollHeight;
            } else {
                logDisplay.textContent = '暂无日志数据';
                logStats.textContent = '日志统计信息不可用';
            }
        } catch (error) {
            console.error('加载日志失败', error);
            document.getElementById('logDisplay').textContent = '加载日志失败: ' + error.message;
            document.getElementById('logStats').textContent = '日志加载失败';
        }
    }

    // 格式化日志内容，添加颜色和过滤
    function formatLogContent(logText) {
        if (!logText) return '';

        // 获取当前选中的日志级别
        const enabledLevels = getEnabledLogLevels();

        return logText.split('\n').map(line => {
            if (!line.trim()) return line;

            let logLevel = '';
            let cssClass = '';

            // 检测日志级别
            if (line.includes('DEBUG')) {
                logLevel = 'DEBUG';
                cssClass = 'log-debug';
            } else if (line.includes('INFO')) {
                logLevel = 'INFO';
                cssClass = 'log-info';
            } else if (line.includes('WARNING') || line.includes('WARN')) {
                logLevel = 'WARNING';
                cssClass = 'log-warning';
            } else if (line.includes('ERROR')) {
                logLevel = 'ERROR';
                cssClass = 'log-error';
            } else if (line.includes('CRITICAL')) {
                logLevel = 'CRITICAL';
                cssClass = 'log-critical';
            }

            // 如果有日志级别且该级别未被选中，则隐藏该行
            if (logLevel && !enabledLevels.includes(logLevel)) {
                return `<div class="${cssClass}" style="display: none;">${escapeHtml(line)}</div>`;
            }

            if (cssClass) {
                return `<div class="${cssClass}">${escapeHtml(line)}</div>`;
            } else {
                return `<div>${escapeHtml(line)}</div>`;
            }
        }).join('');
    }

    // 获取当前启用的日志级别
    function getEnabledLogLevels() {
        const levels = [];
        if (document.getElementById('filter-debug').checked) levels.push('DEBUG');
        if (document.getElementById('filter-info').checked) levels.push('INFO');
        if (document.getElementById('filter-warning').checked) levels.push('WARNING');
        if (document.getElementById('filter-error').checked) levels.push('ERROR');
        if (document.getElementById('filter-critical')) {
            if (document.getElementById('filter-critical').checked) levels.push('CRITICAL');
        }
        return levels;
    }

    // 实时过滤日志显示
    function filterLogDisplay() {
        const logDisplay = document.getElementById('logDisplay');
        const enabledLevels = getEnabledLogLevels();
        const query = (document.getElementById('log-query')?.value || '').trim().toLowerCase();

        // 获取所有日志行
        const logLines = logDisplay.querySelectorAll('div');
        let visibleLines = 0;

        logLines.forEach(line => {
            const classList = line.className || '';
            let shouldShow = false;

            if (classList.includes('log-debug') && enabledLevels.includes('DEBUG')) shouldShow = true;
            if (classList.includes('log-info') && enabledLevels.includes('INFO')) shouldShow = true;
            if (classList.includes('log-warning') && enabledLevels.includes('WARNING')) shouldShow = true;
            if (classList.includes('log-error') && enabledLevels.includes('ERROR')) shouldShow = true;
            if (classList.includes('log-critical') && enabledLevels.includes('CRITICAL')) shouldShow = true;

            // 没有特定级别的行默认显示
            if (!classList.includes('log-debug') && !classList.includes('log-info') &&
                !classList.includes('log-warning') && !classList.includes('log-error') &&
                !classList.includes('log-critical')) {
                shouldShow = true;
            }

            // 关键词筛选
            if (query) {
                const text = (line.textContent || '').toLowerCase();
                shouldShow = shouldShow && text.includes(query);
            }

            line.style.display = shouldShow ? 'block' : 'none';
            if (shouldShow) visibleLines++;
        });

        // 更新统计信息
        const totalLines = logLines.length;
        const logStats = document.getElementById('logStats');
        const levelInfo = enabledLevels.length < 5 ? `级别: ${enabledLevels.join(', ')} | ` : '';
        const queryInfo = query ? `关键词: ${query} | ` : '';
        logStats.textContent = `${queryInfo}${levelInfo}显示 ${visibleLines}/${totalLines} 行日志 | 最后更新: ${new Date().toLocaleTimeString()}`;
    }

    // HTML转义函数
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 复制会话日志（复制过滤后的可见日志）
    async function copySessionLogs() {
        try {
            const logDisplay = document.getElementById('logDisplay');

            // 获取所有可见的日志行（未被过滤隐藏的）
            const visibleLogLines = Array.from(logDisplay.querySelectorAll('div'))
                .filter(div => {
                    // 过滤掉被隐藏的日志行
                    return div.style.display !== 'none' && div.textContent.trim() !== '';
                })
                .map(div => div.textContent);

            if (visibleLogLines.length === 0) {
                showToast('没有可复制的日志（可能被过滤器隐藏）', 'warning');
                return;
            }

            const logsText = visibleLogLines.join('\n');

            // 使用改进的复制函数
            copyToClipboard(logsText, `已复制 ${visibleLogLines.length} 行过滤后的日志到剪贴板`);
        } catch (error) {
            console.error('复制会话日志失败', error);
            showToast('复制会话日志失败', 'error');
        }
    }

    // 通用复制到剪贴板函数
    function copyToClipboard(text, successMessage) {
        // 优先使用现代 Clipboard API，但提供完整的降级方案
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(successMessage, 'success');
            }).catch((error) => {
                console.warn('Clipboard API 失败，使用降级方案:', error);
                fallbackCopy(text, successMessage);
            });
        } else {
            // 降级方案：使用传统的 execCommand
            fallbackCopy(text, successMessage);
        }

        function fallbackCopy(text, successMessage) {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                textarea.style.top = '-999999px';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();

                const successful = document.execCommand('copy');
                document.body.removeChild(textarea);

                if (successful) {
                    showToast(successMessage, 'success');
                } else {
                    showToast('复制失败，请手动复制内容', 'error');
                    console.error('execCommand copy 失败');
                }
            } catch (error) {
                console.error('降级复制方案失败:', error);
                showToast('复制失败: ' + error.message, 'error');
            }
        }
    }

    // 导出日志
    function exportLogs() {
        try {
            window.open('/api/logs/export', '_blank');
        } catch (error) {
            console.error('导出日志失败', error);
            showToast('导出日志失败', 'error');
        }
    }

    // 清除日志
    async function clearLogs() {
        showConfirmToast(
            '确定要清除日志缓存吗？这不会删除日志文件。',
            async () => {
                try {
                    const response = await fetch('/api/logs/clear', {
                        method: 'POST'
                    });

                    if (response.ok) {
                        showToast('日志缓存已清除', 'success');
                        loadLogs(); // 重新加载日志
                    } else {
                        showToast('清除日志缓存失败', 'error');
                    }
                } catch (error) {
                    console.error('清除日志失败', error);
                    showToast('清除日志失败', 'error');
                }
            },
            () => {
                showToast('已取消清除操作', 'info');
            }
        );
    }
</script>
{% endblock %}