{% extends "base.html" %}

{% block title %}é¦–é¡µ - SHTèµ„æºçˆ¬å–ç®¡ç†å¹³å°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/index.css">
{% endblock %}

{% block content %}
<h1 class="page-title">é¦–é¡µ</h1>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <div class="stat-card-label">æ€»èµ„æºæ•°</div>
                <div class="stat-card-value text-rose-500" id="total-count">0</div>
                <div class="stat-card-desc">çˆ¬åˆ°è¿™ä¹ˆå¤šèµ„æºäº†ï¼</div>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <div class="stat-card-label">ä»Šæ—¥æ–°å¢</div>
                <div class="stat-card-value text-emerald-500" id="today-count">0</div>
                <div class="stat-card-desc">ä»Šå¤©çˆ¬åˆ°çš„èµ„æº</div>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <div class="stat-card-label">è¿‘7æ—¥æ–°å¢</div>
                <div class="stat-card-value text-violet-500" id="recent-count">0</div>
                <div class="stat-card-desc text-violet-500">æœ€è¿‘ä¸€å‘¨çš„èµ„æºå¢é•¿é‡</div>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <div class="stat-card-label">æœ€è¿‘æ–°å¢</div>
                <div class="stat-card-value text-blue-500" id="last-crawl-stats">-</div>
                <div class="stat-card-desc text-blue-500" id="last-crawl-desc">æœ€è¿‘ä¸€æ¬¡çˆ¬è™«ç»“æœ</div>
            </div>
        </div>
    </div>
</div>

<!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
<div class="config-card">
    <h3>ç³»ç»ŸçŠ¶æ€</h3>
    <div class="status-grid">
        <div class="status-item">
            <div class="status-label">
                <span class="status-icon"></span>
                <span>çˆ¬è™«çŠ¶æ€</span>
            </div>
            <span id="crawl-status-text" class="status-value">æœªçŸ¥</span>
        </div>
        <div class="status-item">
            <div class="status-label">
                <span class="status-icon"></span>
                <span>æ•°æ®åº“</span>
            </div>
            <span id="db-status-text" class="status-value">æ£€æµ‹ä¸­</span>
        </div>
        <div class="status-item">
            <div class="status-label">
                <span class="status-icon"></span>
                <span>SHT2BM</span>
            </div>
            <span id="sht2bm-status-text" class="status-value">æ£€æµ‹ä¸­</span>
        </div>
        <div class="status-item">
            <div class="status-label">
                <span class="status-icon"></span>
                <span>Telegram Bot</span>
            </div>
            <span id="tg-status-text" class="status-value">æ£€æµ‹ä¸­</span>
        </div>
    </div>
    <!-- 
    <div class="home-actions"
        style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <div></div> 
        <div style="display: flex; gap: 0.75rem; align-items: center;">
            <button id="refreshStatsBtn" class="btn btn-primary" title="åˆ·æ–°ç»Ÿè®¡æ•°æ®">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12a9 9 0 1 1-3.6-7.2"></path>
                    <polyline points="21 3 21 9 15 9"></polyline>
                </svg>
                åˆ·æ–°æ•°æ®
            </button>
            <a href="/crawler" class="btn btn-pink">çˆ¬è™«æ§åˆ¶</a>
            <a href="/config" class="btn btn-purple">ç³»ç»Ÿé…ç½®</a>
        </div>
    </div>
    -->
</div>

<!-- æ¿å—ä¿¡æ¯å¡ç‰‡ (ä»…æŸ¥çœ‹) -->
<div class="config-card">
    <h3>
        <span class="status-icon">ğŸ“‘</span>
        <span>æ¿å—èµ„æºæ¦‚è§ˆ</span>
    </h3>
    <div id="home-forum-list" class="forum-grid">
        <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--muted-foreground);">
            æ­£åœ¨åŠ è½½æ¿å—åˆ—è¡¨...
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é¦–é¡µç‰¹å®šçš„JavaScript
    document.addEventListener('DOMContentLoaded', function () {
        loadStats();
        loadSystemStatus();
        loadLastCrawlStats();
        loadForumInfo();

        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(() => {
            loadSystemStatus();
            loadLastCrawlStats();
        }, 30000); // 30ç§’æ›´æ–°ä¸€æ¬¡

        // æ·»åŠ æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®äº‹ä»¶
        const refreshStatsBtn = document.getElementById('refreshStatsBtn');
        if (refreshStatsBtn) {
            refreshStatsBtn.addEventListener('click', function () {
                // æ˜¾ç¤ºåˆ·æ–°æç¤º
                showToast('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');

                loadStats();
                loadSystemStatus();
                loadLastCrawlStats();
                loadForumInfo();

                // æŒ‰é’®åŠ¨ç”»
                this.style.transform = 'rotate(360deg)';
                this.style.transition = 'transform 0.6s ease';
                setTimeout(() => {
                    this.style.transform = '';
                    showToast('æ•°æ®å·²åˆ·æ–°', 'success');
                }, 600);
            });
        }
    });

    // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            const stats = await response.json();

            const totalEl = document.getElementById('total-count');
            const todayEl = document.getElementById('today-count');
            const recentEl = document.getElementById('recent-count');

            if (totalEl) totalEl.textContent = stats.total_count || 0;
            if (todayEl) todayEl.textContent = stats.today_count || 0;
            if (recentEl) recentEl.textContent = stats.recent_count || 0;
        } catch (error) {
            console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }
    }

    // åŠ è½½ç³»ç»ŸçŠ¶æ€
    async function loadSystemStatus() {
        try {
            const [healthResponse, crawlResponse] = await Promise.all([
                fetch('/api/health'),
                fetch('/api/crawl/status')
            ]);

            const health = await healthResponse.json();
            const crawlStatus = await crawlResponse.json();

            // æ›´æ–°çˆ¬è™«çŠ¶æ€
            const crawlStatusEl = document.getElementById('crawl-status-text');
            if (crawlStatusEl) {
                crawlStatusEl.textContent = crawlStatus.message || 'ç©ºé—²';
                crawlStatusEl.className = `status-value ${crawlStatus.is_crawling ? 'text-emerald-500' : 'text-muted-foreground'}`;
            }

            // æ›´æ–°æ•°æ®åº“çŠ¶æ€
            const dbStatusEl = document.getElementById('db-status-text');
            if (dbStatusEl) {
                const dbOk = health.database?.status === 'ok';
                dbStatusEl.textContent = dbOk ? 'æ­£å¸¸' : 'å¼‚å¸¸';
                dbStatusEl.className = `status-value ${dbOk ? 'text-emerald-500' : 'text-rose-500'}`;
            }

            // æ›´æ–°SHT2BMçŠ¶æ€
            const sht2bmStatusEl = document.getElementById('sht2bm-status-text');
            if (sht2bmStatusEl && health.sht2bm) {
                const sht2bmOk = health.sht2bm.status === 'ok';
                sht2bmStatusEl.textContent = sht2bmOk ? 'è¿è¡Œä¸­' : (health.sht2bm.enabled ? 'å·²åœæ­¢' : 'æœªå¯ç”¨');
                sht2bmStatusEl.className = `status-value ${sht2bmOk ? 'text-emerald-500' : 'text-muted-foreground'}`;
            }

            // æ›´æ–°Telegram BotçŠ¶æ€
            const tgStatusEl = document.getElementById('tg-status-text');
            if (tgStatusEl) {
                const tgEnabled = health.config?.telegram_enabled;
                tgStatusEl.textContent = tgEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
                tgStatusEl.className = `status-value ${tgEnabled ? 'text-emerald-500' : 'text-muted-foreground'}`;
            }
        } catch (error) {
            console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
        }
    }

    // åŠ è½½æœ€è¿‘çˆ¬è™«ç»Ÿè®¡
    async function loadLastCrawlStats() {
        try {
            const response = await fetch('/api/crawl/status');
            const status = await response.json();

            const statsEl = document.getElementById('last-crawl-stats');
            const descEl = document.getElementById('last-crawl-desc');

            if (status.last_result && status.last_result.total_saved !== undefined) {
                const result = status.last_result;
                const saved = result.total_saved || 0;
                const skipped = result.total_skipped || 0;
                const failed = result.total_failed || 0;

                if (statsEl) {
                    if (saved > 0) {
                        statsEl.textContent = `+${saved}`;
                        statsEl.className = 'stat-card-value text-emerald-500';
                    } else if (failed > 0) {
                        statsEl.textContent = `${failed}å¤±è´¥`;
                        statsEl.className = 'stat-card-value text-rose-500';
                    } else {
                        statsEl.textContent = '0';
                        statsEl.className = 'stat-card-value text-muted-foreground';
                    }
                }

                if (descEl) {
                    const timestamp = result.timestamp ? new Date(result.timestamp).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                    if (saved > 0 && skipped > 0) {
                        descEl.textContent = `æˆåŠŸ${saved}ï¼Œè·³è¿‡${skipped}`;
                    } else if (saved > 0) {
                        descEl.textContent = `æˆåŠŸè·å–${saved}æ¡`;
                    } else if (failed > 0) {
                        descEl.textContent = `${failed}ä¸ªé¡µé¢å¤±è´¥`;
                    } else {
                        descEl.textContent = 'æš‚æ— æ–°å¢';
                    }
                }
            } else {
                if (statsEl) {
                    statsEl.textContent = '-';
                    statsEl.className = 'stat-card-value text-muted-foreground';
                }
                if (descEl) {
                    descEl.textContent = 'æš‚æ— çˆ¬å–è®°å½•';
                }
            }
        } catch (error) {
            console.error('åŠ è½½æœ€è¿‘çˆ¬è™«ç»Ÿè®¡å¤±è´¥:', error);
        }
    }

    // åŠ è½½æ¿å—ä¿¡æ¯ï¼ˆä»…æŸ¥çœ‹ï¼‰
    async function loadForumInfo() {
        const listEl = document.getElementById('home-forum-list');
        if (!listEl) return;

        try {
            // å¹¶å‘è·å–è®ºå›ä¿¡æ¯å’Œæœ€æ–°ç»Ÿè®¡æ•°æ®
            const [forumResponse, statsResponse] = await Promise.all([
                fetch('/api/forum/info/batch?fast=false&force=false'),
                fetch('/api/stats/categories')
            ]);

            if (!forumResponse.ok || !statsResponse.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');

            const forumData = await forumResponse.json();
            const statsData = await statsResponse.json();

            if (forumData.status !== 'success' || !forumData.data) {
                throw new Error(forumData.message || 'æ•°æ®æ ¼å¼é”™è¯¯');
            }

            const forums = forumData.data;
            const forumKeys = Object.keys(forums);

            if (forumKeys.length === 0) {
                listEl.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--muted-foreground);">
                        æš‚æ— æ¿å—æ•°æ®
                    </div>
                `;
                return;
            }

            // å¤„ç†ç»Ÿè®¡æ•°æ®
            const categoryStats = {};
            const statsPayload = Array.isArray(statsData) ? statsData : (statsData.data || []);

            if (Array.isArray(statsPayload)) {
                statsPayload.forEach(stat => {
                    const sectionName = stat.section || stat.name;
                    if (sectionName && sectionName !== 'æœªçŸ¥') {
                        const count = stat.count !== undefined ? stat.count : (stat.resource_count || 0);
                        categoryStats[sectionName] = count;
                    }
                });
            }

            listEl.innerHTML = '';

            Object.entries(forums).forEach(([fid, info]) => {
                const forumCard = document.createElement('div');
                forumCard.className = 'forum-card'; // ä½¿ç”¨ä¸çˆ¬è™«é¡µç›¸åŒçš„ç±»åï¼Œæ ·å¼åœ¨index.cssä¸­é‡å®šä¹‰ä¸ºåªè¯»

                const localCount = categoryStats[info.name] || 0;

                // æ•°æ®å­—æ®µå…¼å®¹å¤„ç†
                const remoteTopics = info.total_topics ?? info.topics ?? null;
                const remotePages = info.total_pages ?? info.pages ?? null;
                const hasWarning = remoteTopics === null || remotePages === null;

                forumCard.innerHTML = `
                    <div class="forum-card-header">
                        <div class="forum-name">
                            ${info.name || `æ¿å—${fid}`}
                            ${hasWarning ? '<span style="color: #f59e0b; margin-left: 0.5rem;" title="æ•°æ®ä¸å®Œæ•´">âš ï¸</span>' : ''}
                        </div>
                        <div class="forum-fid">FID: ${fid}</div>
                    </div>
                    <div class="forum-stats">
                        <div>è¿œç¨‹ä¸»é¢˜: ${remoteTopics !== null ? remoteTopics : 'æœªçŸ¥'}</div>
                        <div>è¿œç¨‹é¡µæ•°: ${remotePages !== null ? remotePages : 'æœªçŸ¥'}</div>
                        <div>æœ¬åœ°ä¸»é¢˜: <strong style="color: var(--emerald-500);">${localCount}</strong></div>
                    </div>
                `;

                listEl.appendChild(forumCard);
            });

        } catch (error) {
            console.error('åŠ è½½æ¿å—ä¿¡æ¯å¤±è´¥:', error);
            listEl.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--rose-500);">
                    åŠ è½½å¤±è´¥: ${error.message}
                </div>
            `;
        }
    }
</script>
{% endblock %}